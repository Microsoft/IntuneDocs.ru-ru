---
title: Настройка инфраструктуры сертификатов для SCEP | Microsoft Intune
description:
keywords:
author: nbigman
manager: jeffgilb
ms.date: 05/16/2016
ms.topic: article
ms.prod:
ms.service: microsoft-intune
ms.technology:
ms.assetid: 4ae137ae-34e5-4a45-950c-983de831270f


# optional metadata

#ROBOTS:
#audience:
#ms.devlang:
ms.reviewer: kmyrup
ms.suite: ems
#ms.tgt_pltfrm:
#ms.custom:
---
# Настройка инфраструктуры сертификатов для SCEP
В этом разделе описывается инфраструктура, которая необходима для создания и развертывания профилей сертификатов.

### Локальная инфраструктура

-    **Домен Active Directory**: все серверы, указанные в этом разделе (за исключением сервера прокси-службы веб-приложения), должны быть присоединены к домену Active Directory.

-  **Центр сертификации** (ЦС): вам требуется центр сертификации предприятия под управлением выпуска Enterprise Windows Server 2008 R2 или более поздней версии. Автономный ЦС не поддерживается. Инструкции по настройке центра сертификации см. в разделе [Установка центра сертификации](http://technet.microsoft.com/library/jj125375.aspx).
    Если ЦС выполняется под управлением Windows Server 2008 R2, необходимо [установить исправление из KB2483564](http://support.microsoft.com/kb/2483564/).
I
-  **Сервер NDES**: на сервере под управлением Windows Server 2012 R2 или более поздней версии необходимо настроить службу регистрации сертификатов для сетевых устройств (NDES). Intune не поддерживает использование службы NDES, если выполняется на сервере, где также запущен ЦС предприятия. Инструкции по настройке Windows Server 2012 R2 для размещения службы регистрации сертификатов для сетевых устройств см. в разделе [Руководство по службе регистрации сертификатов для сетевых устройств](http://technet.microsoft.com/library/hh831498.aspx). NDES-сервер должен быть присоединен к домену, на котором размещен центр сертификации, и не может находиться на одном сервере с центром сертификации. Дополнительные сведения о развертывании сервера NDES в отдельном лесу, изолированной сети или на внутреннем домене можно найти в разделе [Использование модуля политики совместно со службой регистрации сертификатов для сетевых устройств](https://technet.microsoft.com/en-us/library/dn473016.aspx).

-  **Соединитель сертификатов Microsoft Intune**: используйте консоль администрирования Intune, чтобы скачать установщик **соединителя сертификатов** (**ndesconnectorssetup.exe**). Затем вы можете запустить **ndesconnectorssetup.exe** на компьютере, где требуется установить соединитель сертификатов.
-  **Cервер прокси-службы веб-приложения** (необязательно): вы можете использовать сервер под управлением Windows Server 2012 R2 или более поздней версии в качестве сервера прокси-службы веб-приложения (WAP). Эта конфигурация:
    -  позволяет устройствам получать сертификаты, используя подключение к Интернету;
    -  является рекомендацией по безопасности, если устройства подключаются к Интернету для получения или возобновления действия сертификатов.

 > [!NOTE]           
> -    На сервере, где размещается WAP, [необходимо установить обновление](http://blogs.technet.com/b/ems/archive/2014/12/11/hotfix-large-uri-request-in-web-application-proxy-on-windows-server-2012-r2.aspx) , обеспечивающее поддержку длинных URL-адресов, которые используются службой регистрации сертификатов для сетевых устройств. Это обновление включено в [накопительный пакет обновления за декабрь 2014 г.](http://support.microsoft.com/kb/3013769), или его можно получить отдельно из [KB3011135](http://support.microsoft.com/kb/3011135).
>-  Сервер, на котором размещается WAP, также должен иметь SSL-сертификат, совпадающий с именем, опубликованным для внешних клиентов, и доверять SSL-сертификату, который используется на сервере NDES. Эти сертификаты позволяют WAP-серверу разорвать SSL-соединение клиентов и создать новое SSL-соединение с сервером NDES.
Сведения о сертификатах для WAP см. в подразделе **Планирование сертификатов** раздела [Планирование публикации приложений с помощью прокси-службы веб-приложения](https://technet.microsoft.com/library/dn383650.aspx). Общие сведения о WAP-серверах см. в разделе [Работа с прокси-службой веб-приложения](http://technet.microsoft.com/library/dn584113.aspx).|

### Требования к сети

Для подключений из Интернета к сети периметра разрешите порт 443 со всех узлов или IP-адресов в Интернете на сервер NDES.

Для подключений из сети периметра к доверенной сети разрешите все порты и протоколы, необходимые для доступа к домену на сервере NDES, присоединенном к домену. Серверу NDES необходим доступ к серверам сертификатов, DNS-серверам, серверам Configuration Manager и контроллерам домена.


### <a name="BKMK_CertsAndTemplates"></a>Сертификаты и шаблоны

|Объект|Подробные сведения|
|----------|-----------|
|**Шаблон сертификата**|Настройте этот шаблон в выдающем ЦС.|
|**Сертификат проверки подлинности клиента**|Сертификат, запрошенный из выдающего или общедоступного ЦС, устанавливается на сервере NDES.|
|**Сертификат проверки подлинности сервера**|SSL-сертификат, запрошенный из выдающего или общедоступного ЦС, устанавливается и привязывается в IIS на сервере NDES.|
|**Доверенный корневой сертификат ЦС**|Вы экспортируете его в виде **CER**-файла из корневого ЦС или с любого устройства, доверяющего корневому ЦС, и развертываете его на устройствах, используя профиль сертификата доверенного ЦС.<br /><br />Для каждой платформы операционной системы используется один доверенный корневой сертификат ЦС, который связывается с каждым созданным профилем доверенного корневого сертификата.<br /><br />При необходимости можно использовать дополнительные доверенные корневые сертификаты ЦС. Например, это можно сделать, чтобы предоставить доверие ЦС, подписывающему сертификаты проверки подлинности сервера для точек доступа Wi-Fi.|

### <a name="BKMK_Accounts"></a>Учетные записи

|Имя|Подробные сведения|
|--------|-----------|
|**Учетная запись службы NDES**|Учетная запись пользователя домена указывается для использования в качестве учетной записи службы NDES.|

## <a name="BKMK_ConfigureInfrastructure"></a>Настройка инфраструктуры
Перед тем как вы сможете настроить профили сертификатов, необходимо выполнить следующие задачи, для которых требуется знание Windows Server 2012 R2 и служб сертификатов Active Directory (ADCS):

**Задача 1**. Создание учетной записи службы NDES

**Задача 2**. Настройка шаблонов сертификатов в центре сертификации

**Задача 3**. Настройка необходимых компонентов на сервере NDES

**Задача 4**. Настройка NDES для использования с Intune

**Задача 5**. Включение, установка и настройка соединителя сертификатов Intune

### Задача 1. Создание учетной записи службы NDES

Создайте учетную запись пользователя домена для использования в качестве учетной записи службы NDES. Эту учетную запись потребуется указать при настройке шаблонов в выдающем ЦС перед установкой и настройкой NDES. Убедитесь, что пользователь имеет следующие права по умолчанию: **Локальный вход**, **Вход в качестве службы** и **Вход в качестве пакетного задания**. Некоторые организации имеют политики усиления защиты, которые отключают эти права.




### Задача 2. Настройка шаблонов сертификатов в центре сертификации
В этой задаче вы:

-   настроите шаблон сертификата для NDES;

-   опубликуете шаблон сертификата для NDES.

##### Настройка центра сертификации

1.  Войдите в систему как администратор организации. 

2.  В выдающем ЦС используйте оснастку шаблонов сертификатов, чтобы создать новый пользовательский шаблон или скопировать существующий, а затем измените существующий шаблон (например, шаблон пользователя) для использования в NDES.

    Шаблон должен иметь следующие настройки.

    -   Укажите понятное **Отображаемое имя шаблона** .

    -   На вкладке **Имя субъекта** выберите **Отправить в запросе**. (Безопасность обеспечивается модулем политики Intune для NDES.)

    -   На вкладке **Расширения** включите в раздел **Описание политик приложений** пункт **Проверка подлинности клиента**.

        > [!IMPORTANT] Для шаблонов сертификатов iOS и Mac OS X измените на вкладке **Расширения** параметр **Использование ключей** и снимите флажок **Подпись подтверждает подлинность**.

    -   На вкладке **Безопасность** добавьте учетную запись службы NDES и предоставьте ей разрешения **Регистрация** для шаблона. Администраторам Intune, которые будут создавать профили SCEP, потребуются права на **Чтение**, чтобы они могли просматривать шаблон при создании профилей SCEP.
    
    > [!NOTE] Для отзыва сертификатов учетной записи службы NDES требуются права *Выдача сертификатов и управление ими* для каждого шаблона сертификата, используемого профилем сертификата.

3.  Просмотрите **Период действия** на вкладке **Общие** шаблона. По умолчанию в Intune используется значение, настроенное в шаблоне. Однако в настройках ЦС вы можете разрешить инициатору запроса указывать другое значение, которое можно затем задать в консоли администрирования Intune. Если вы хотите всегда использовать значение в шаблоне, пропустите остальные действия этого шага.

    > [!IMPORTANT] Платформы iOS и Mac OS X всегда используют значение, заданное в шаблоне, независимо от других настроек.

Ниже приведены снимки экрана для примера настройки шаблона.

![Шаблон, вкладка "Обработка запроса"](..\media\scep_ndes_request_handling.png) 

![Шаблон, вкладка "Имя субъекта"](..\media\scep_ndes_subject_name.jpg) 

![Шаблон, вкладка "Безопасность"](..\media\scep_ndes_security.jpg) 

![Шаблон, вкладка "Расширения"](..\media\scep_ndes_extensions.jpg) 

![Шаблон, вкладка "Требования выдачи"](..\media\scep_ndes_issuance_reqs.jpg) 

>   [!IMPORTANT]
    > Для политик приложения (на четвертом снимке экрана) добавьте только необходимые политики. Согласуйте выбранные параметры с администраторами безопасности.
   


Чтобы настройки ЦС позволяли инициатору запроса указывать период действия, выполните в ЦС следующие команды:

   1.  **certutil -setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE**
   2.  **net stop certsvc**

   3.  **net start certsvc**

4.  В выдающем ЦС используйте оснастку центра сертификации, чтобы опубликовать шаблон сертификата.

    1.  Выберите узел **Шаблоны сертификата**, щелкните **Действие**-&gt; **Создать** &gt; **Выдаваемый шаблон сертификата**, а затем укажите шаблон, созданный в шаге 2.

    2.  Убедитесь, что шаблон опубликован, просмотрев его в папке **Шаблоны сертификата** .


### Задача 3. Настройка необходимых компонентов на сервере NDES
В этой задаче вы:

-   добавите NDES к Windows Server и настроите в IIS поддержку NDES;

-   добавите учетную запись службы NDES в группу IIS_IUSR;

-   настроите SPN для учетной записи службы NDES.




   1.  На сервер, где размещается NDES, необходимо войти как **Администратор предприятия**, а затем использовать [Мастер добавления ролей и компонентов](https://technet.microsoft.com/library/hh831809.aspx) для установки NDES:

    1.  В мастере выберите **Службы сертификатов Active Directory** , чтобы получить доступ к службам ролей служб сертификатов Active Directory. Выберите **Служба регистрации сертификатов для сетевых устройств**, снимите флажок **Центр сертификации**, а затем завершите работу мастера.

        > [!TIP]
        > На странице **Ход установки** мастера не нажимайте кнопку **Закрыть**. Вместо этого щелкните ссылку **Настроить службы сертификатов Active Directory на конечном сервере**. Откроется мастер **настройки служб сертификатов Active Directory** , который будет использован для следующей задачи. После того, как откроется окно настройки служб сертификатов Active Directory, можно закрыть мастер добавления ролей и компонентов.

    2.  При добавлении NDES на сервер мастер также установит IIS. Убедитесь, что в IIS настройки заданы следующим образом:

        -   **Веб-сервер** &gt; **Безопасность** &gt; **Фильтрация запросов**

        -   **Веб-сервер** &gt; **Развертывание приложений** &gt; **ASP.NET 3.5**. При установке ASP.NET 3.5 будет установлена платформа .NET Framework 3.5. При установке .NET Framework 3.5 установите основной компонент **.NET Framework 3.5** и компонент **Активация по HTTP**.

        -   **Веб-сервер** &gt; **Развертывание приложений** &gt; **ASP.NET 4.5**. При установке ASP.NET 4.5 будет установлена платформа .NET Framework 4.5. При установке .NET Framework 4.5 установите основной компонент **.NET Framework 4.5**, **ASP.NET 4.5** и компонент **Службы WCF** &gt; **Активация по HTTP**.

        -   **Средства управления** &gt; **Совместимость управления IIS 6** &gt; **Совместимость метабазы IIS 6**

        -   **Средства управления** &gt; **Совместимость управления IIS 6** &gt; **Совместимость WMI IIS 6**

  2.  На сервере добавьте учетную запись службы NDES в качестве участника группы **IIS_IUSR**.

   3.  Выполните следующую команду, чтобы настроить SPN для учетной записи службы NDES:

`**setspn -s http/&lt;DNS name of NDES Server&gt; &lt;Domain name&gt;\&lt;NDES Service account name&gt;**`

   Например, если имя сервера NDES — **Server01**, домен — **Contoso.com**, а учетная запись службы — **NDESService**, используйте:

`**setspn –s http/Server01.contoso.com contoso\NDESService**`

### Задача 4. Настройка NDES для использования с Intune
В этой задаче вы:

-   настроите NDES для использования с выдающим ЦС;

-   привяжете сертификат проверки подлинности сервера (SSL-сертификат) в IIS;

-   настроите фильтрацию запросов в IIS.

##### Настройка NDES для использования с Intune

1.  На сервере NDES откройте мастер настройки служб сертификатов Active Directory и внесите следующие изменения.

    > [!TIP]
    > Если вы щелкнули ссылку в предыдущей задаче, этот мастер будет уже открыт. В противном случае откройте диспетчер серверов, чтобы получить доступ к настройке служб сертификатов Active Directory после развертывания.

    -   На странице **Службы ролей** выберите **Служба регистрации сертификатов для сетевых устройств**.

    -   На странице **Учетная запись службы для NDES** укажите учетную запись службы NDES.

    -   На странице **ЦС для NDES** щелкните **Выбрать**и укажите выдающий ЦС, в котором настроен шаблон сертификата.

    -   На странице **Криптография для NDES** задайте длину ключа, соответствующую требованиям компании.

    На странице **Подтверждение** щелкните **Настроить** , чтобы завершить работу мастера.

2.  После завершения работы мастера измените следующий раздел реестра на сервере NDES:

    -   **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MSCEP\**

    Чтобы изменить этот раздел, задайте **Назначение** шаблона сертификата на вкладке **Обработка запроса**, а затем измените соответствующую запись в реестре, заменив существующие данные именем шаблона сертификата (но не отображаемым именем шаблона), указанным в задаче 1. Следующая таблица содержит соответствия назначений шаблона сертификата и значений в реестре:

    |Назначение шаблона сертификата (на вкладке "Обработка запросов")|Изменяемое значение реестра|Значение, отображающееся в консоли администрирования Intune для профиля SCEP|
    |--------------------------------------------------------------|--------------------------|------------------------------------------------------------------------------------------------------------|
    |Подпись|SignatureTemplate|Цифровая подпись|
    |Шифрование|EncryptionTemplate|Шифрование ключа|
    |Подпись и шифрование|GeneralPurposeTemplate|Шифрование ключа<br /><br />Цифровая подпись|
    Например, если назначение шаблона сертификата — **Шифрование**, измените значение **EncryptionTemplate** на имя шаблона сертификата.

3. Сервер NDES получит очень длинные URL-адреса (запросы), для которых необходимо добавить две записи реестра:

    |Расположение|Значение|Type|Миграция|
    |-------|-----|----|----|
    |HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters|MaxFieldLength|DWORD|65534 (десятичное число)|
    |HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters|MaxRequestBytes|DWORD|65534 (десятичное число)|


4. В диспетчере IIS выберите **Веб-сайт по умолчанию** -> **Фильтрация запросов** -> **Изменить параметр функции** и установите значения параметров **Максимальная длина URL-адреса** и **Максимальная длина строки запроса** в *65534*, как показано ниже.

    ![Максимальная длина URL-адреса IIS и длина запроса](..\media\SCEP_IIS_max_URL.png) 

5.  Перезагрузите сервер. Для завершения этих изменений будет недостаточно выполнить команду **iisreset** на сервере.
6. Перейдите по ссылке http://*FQDN*/certsrv/mscep/mscep.dll. Вы должны увидеть примерно следующую страницу NDES:

    ![Проверка NDES](..\media\SCEP_NDES_URL.png) 

    Если вы получаете ответ **503 — служба недоступна**, проверьте средство просмотра событий. Вполне вероятно, что пул приложений остановлен из-за отсутствия прав у пользователя NDES. Эти права описаны в Задаче 1.

##### Установка и привязка сертификатов на сервере NDES

1.  На сервере NDES запросите и установите сертификат **проверки подлинности сервера** из внутреннего или общедоступного ЦС. Затем этот SSL-сертификат будет привязан в IIS.

    > [!TIP]
    > После привязки SSL-сертификата в IIS вы также установите сертификат проверки подлинности клиента. Этот сертификат может выдать любой ЦС, которому доверяет сервер NDES. Хотя это не рекомендуется, тот же сертификат можно использовать для проверки подлинности как сервера, так и клиента, если этот сертификат имеет оба расширенных использования ключа (EKU). Дополнительные сведения об этих сертификатах проверки подлинности см. в следующих шагах.

    1.  После получения сертификата проверки подлинности сервера откройте **Диспетчер IIS**, выберите **Веб-сайт по умолчанию** на панели **Подключения** и щелкните **Привязки** на панели **Действия** .

    2.  Нажмите кнопку **Добавить**, задайте для пункта **Тип** значение **https**, а затем укажите порт **443**. (Для автономной службы Intune поддерживается только порт 443.)

    3.  В качестве **SSL-сертификата**укажите сертификат проверки подлинности сервера.

        > [!NOTE] Если сервер NDES использует как внешнее, так и внутреннее имя для одного сетевого адреса, сертификат проверки подлинности сервера должен иметь **Имя субъекта** с внешним общедоступным именем сервера и **Альтернативное имя субъекта**, включающее внутреннее имя сервера.

2.  На сервере NDES запросите и установите сертификат **проверки подлинности клиента** из внутреннего или общедоступного ЦС. Это может быть тот же сертификат, что и сертификат проверки подлинности сервера, если этот сертификат поддерживает обе возможности.

    Сертификат проверки подлинности клиента должен иметь следующие свойства:

    **Расширенное использование ключа** — оно должно включать **Проверку подлинности клиента**.

    **Имя субъекта** должно совпадать с DNS-именем сервера, на котором устанавливается сертификат (сервер NDES).

##### Настройка фильтрации запросов IIS

1.  На сервере NDES откройте **Диспетчер IIS**, выберите на панели **Подключения** **Веб-сайт по умолчанию** , а затем откройте вкладку **Фильтрация запросов**.

2.  Щелкните **Изменить параметры функций**и задайте следующее:

    **строка запроса (в байтах)** = **65534**

    **Максимальная длина URL-адреса (байт)** = **65534**

3.  Проверьте следующий раздел реестра:

    **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HTTP\Parameters**

    Убедитесь, что в качестве записей DWORD установлены следующие значения:

    Имя: **MaxFieldLength**с десятичным значением **65 534**

    Имя: **MaxRequestBytes**с десятичным значением **65 534**

4.  Перезагрузите NDES-сервер. Сервер теперь поддерживает соединитель сертификатов.

### Задача 5. Включение, установка и настройка соединителя сертификатов Intune
В этой задаче вы:

включите поддержку NDES в Intune;

скачаете, установите и настроите соединитель сертификатов на сервере NDES.

##### Включение поддержки для соединителя сертификатов

1.  Откройте [консоль администрирования Intune](https://manage.microsoft.com), щелкните **Администрирование** &gt; **Соединитель сертификатов**.

2.  Щелкните **Настройка локального соединителя сертификатов**.

3.  Выберите **Включить соединитель сертификатов**, а затем нажмите кнопку **ОК**.

##### Скачивание, установка и настройка соединителя сертификатов

1.  Откройте [консоль администрирования Intune](https://manage.microsoft.com), а затем щелкните **Администрирование** &gt; **Управление мобильными устройствами** &gt; **Соединитель сертификатов** &gt; **Скачать соединитель сертификатов**.

2.  После скачивания запустите установщик (**ndesconnectorssetup.exe**) на сервере Windows Server 2012 R2. Также будет установлен модуль политики для NDES и веб-службы CRP. (Веб-служба CRP, CertificateRegistrationSvc, выполняется в IIS как приложение.)

    > [!NOTE]
    > При установке NDES для автономной службы Intune служба CRP автоматически устанавливается вместе с соединителем сертификатов. При использовании Intune с Configuration Manager точка регистрации сертификатов устанавливается как отдельная роль системы сайта.

3.  При запросе сертификата клиента для соединителя сертификатов щелкните **Выбрать**и укажите сертификат **проверки подлинности клиента** , установленный на сервере NDES в задаче 3.

    После выбора сертификата проверки подлинности клиента вы вернетесь на поверхность **Сертификата клиента для соединителя сертификатов Microsoft Intune** . Хотя выбранный сертификат не отображается, нажмите кнопку **Далее** , чтобы просмотреть свойства этого сертификата. Затем нажмите кнопки **Далее**и **Установить**.

4.  После завершения работы мастера, но перед тем, как закрыть его, щелкните **Запустить пользовательский интерфейс соединителя сертификатов**.

    > [!TIP] Если вы закрыли мастер перед запуском пользовательского интерфейса соединителя сертификатов, вы можете повторно открыть его, выполнив следующую команду:
    >
    > **&lt;путь_установки&gt;\NDESConnectorUI\NDESConnectorUI.exe**

5.  В пользовательском интерфейсе **соединителя сертификатов** :

    Щелкните **Войти** и введите учетные данные администратора службы Intune или учетные данные администратора клиента с разрешениями глобального администратора.

    Если ваша организация использует прокси-сервер и он требуется для подключения сервера NDES к Интернету, щелкните пункт **Использовать прокси-сервер** и укажите имя, порт и учетные данные учетной записи прокси-сервера для подключения.

    Откройте вкладку **Дополнительно** , а затем укажите учетные данные учетной записи с разрешением **Выдача сертификатов и управление ими** в выдающем центре сертификации и нажмите кнопку **Применить**.

    Теперь можно закрыть пользовательский интерфейс соединителя сертификатов.

6.  Откройте командную строку и введите **services.msc**, а затем нажмите клавишу **ВВОД**, щелкните правой кнопкой мыши элемент **Служба соединителя Intune** и выберите пункт **Перезапустить**.

Чтобы убедиться, что служба работает, откройте браузер и введите следующий URL-адрес (он должен вернуть ошибку **403** ):

**http:// &lt;полное_доменное_имя_сервера_NDES&gt;/certsrv/mscep/mscep.dll**

## Дальнейшие действия
Теперь вы готовы к настройке профилей сертификатов, как описано в разделе [Настройка профилей сертификатов](Configure-Intune-certificate-profiles.md).


<!--HONumber=Jun16_HO1-->


