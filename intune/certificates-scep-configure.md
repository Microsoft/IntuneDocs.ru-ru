---
title: Использование сертификатов SCEP в Microsoft Intune в Azure | Документы Майкрософт
description: Для использования сертификатов SCEP в Microsoft Intune следует настроить локальный домен AD, создать центр сертификации, настроить сервер NDES и установить Intune Certificate Connector. Затем нужно создать профиль сертификата SCEP и назначить его группам.
keywords: ''
author: MandiOhlinger
ms.author: mandia
manager: dougeby
ms.date: 04/23/2018
ms.topic: article
ms.prod: ''
ms.service: microsoft-intune
ms.technology: ''
ms.reviewer: kmyrup
ms.suite: ems
ms.custom: intune-azure
ms.openlocfilehash: 834eb66e21820880f644c33d7e5d6aedad6bd502
ms.sourcegitcommit: 401cedcd7acc6cb3a6f18d4679bdadb0e0cdf443
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
---
# <a name="configure-and-use-scep-certificates-with-intune"></a>Настройка и использование сертификатов SCEP в Intune

[!INCLUDE [azure_portal](./includes/azure_portal.md)]

В этой статье показано, как настроить инфраструктуру, а затем создать и назначить профили сертификатов SCEP (Simple Certificate Enrollment Protocol) с помощью Intune.

## <a name="configure-on-premises-infrastructure"></a>Настройка локальной инфраструктуры

- **Домен Active Directory**: все серверы, указанные в этом разделе (за исключением сервера прокси-службы веб-приложения), должны быть присоединены к домену Active Directory.

- **Центр сертификации** (ЦС): вам требуется центр сертификации предприятия под управлением выпуска Enterprise Windows Server 2008 R2 или более поздней версии. Автономный ЦС не поддерживается. Дополнительные сведения см. в разделе [Установка центра сертификации](http://technet.microsoft.com/library/jj125375.aspx).
    Если ЦС выполняется под управлением Windows Server 2008 R2, необходимо [установить исправление из KB2483564](http://support.microsoft.com/kb/2483564/).

- **Сервер NDES**: на сервере под управлением Windows Server 2012 R2 или более поздней версии необходимо настроить службу регистрации сертификатов для сетевых устройств (NDES). Intune не поддерживает использование службы NDES, если выполняется на сервере, где также запущен ЦС предприятия. Инструкции по настройке Windows Server 2012 R2 для размещения службы регистрации сертификатов для сетевых устройств см. в разделе [Руководство по службе регистрации сертификатов для сетевых устройств](http://technet.microsoft.com/library/hh831498.aspx).
NDES-сервер должен быть присоединен к домену, на котором размещен центр сертификации, и не может находиться на одном сервере с центром сертификации. Дополнительные сведения о развертывании сервера NDES в отдельном лесу, изолированной сети или на внутреннем домене можно найти в разделе [Использование модуля политики совместно со службой регистрации сертификатов для сетевых устройств](https://technet.microsoft.com/library/dn473016.aspx).

- **Соединитель сертификатов Microsoft Intune**: используйте портал Azure, чтобы скачать установщик **соединителя сертификатов** (**ndesconnectorssetup.exe**). Затем вы можете запустить программу **ndesconnectorssetup.exe** на сервере, на котором расположена роль службы регистрации сертификатов для сетевых устройств (NDES), где вы хотите установите соединитель сертификатов. 
- **Сервер прокси-службы веб-приложения** (необязательно): используйте сервер под управлением Windows Server 2012 R2 или более поздней версии в качестве сервера прокси-службы веб-приложения (WAP). Эта конфигурация:
  -  позволяет устройствам получать сертификаты, используя подключение к Интернету;
  -  является рекомендацией по безопасности, если устройства подключаются к Интернету для получения или возобновления действия сертификатов.

#### <a name="additional"></a>Дополнительно
- На сервере, где размещается WAP, [необходимо установить обновление](http://blogs.technet.com/b/ems/archive/2014/12/11/hotfix-large-uri-request-in-web-application-proxy-on-windows-server-2012-r2.aspx) , обеспечивающее поддержку длинных URL-адресов, которые используются службой регистрации сертификатов для сетевых устройств. Это обновление включено в [накопительный пакет обновления за декабрь 2014 г.](http://support.microsoft.com/kb/3013769), или его можно получить отдельно из [KB3011135](http://support.microsoft.com/kb/3011135).
- Сервер WAP должен иметь SSL-сертификат, совпадающий с именем, опубликованным для внешних клиентов, и доверять SSL-сертификату, который используется на сервере NDES. Эти сертификаты позволяют WAP-серверу разорвать SSL-соединение клиентов и создать новое SSL-соединение с сервером NDES.

См. дополнительные сведения о [планировании сертификатов для WAP](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn383650(v=ws.11)#plan-certificates) и [серверах WAP](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn584113(v=ws.11)).

### <a name="network-requirements"></a>Требования к сети

В сети, расположенной между Интернетом и периметром, разрешите всем узлам или IP-адресам в Интернете подключаться к серверу NDES через порт 443.

Для подключений из сети периметра к доверенной сети разрешите все порты и протоколы, необходимые для доступа к домену на сервере NDES, присоединенном к домену. Серверу NDES необходим доступ к серверам сертификатов, DNS-серверам, серверам Configuration Manager и контроллерам домена.

Рекомендуется публиковать сервер NDES через прокси, например через [прокси приложения Azure AD](https://azure.microsoft.com/documentation/articles/active-directory-application-proxy-publish/), [прокси веб-доступа](https://technet.microsoft.com/library/dn584107.aspx) или прокси-сервер стороннего поставщика.

### <a name="certificates-and-templates"></a>Сертификаты и шаблоны

|Объект|Подробные сведения|
|----------|-----------|
|**Шаблон сертификата**|Настройте этот шаблон в выдающем ЦС.|
|**Сертификат проверки подлинности клиента**|Сертификат, запрошенный из выдающего или общедоступного ЦС, устанавливается на сервере NDES.|
|**Сертификат проверки подлинности сервера**|SSL-сертификат, запрошенный из выдающего или общедоступного ЦС, устанавливается и привязывается в IIS на сервере NDES.|
|**Доверенный корневой сертификат ЦС**|Экспортируете сертификат в виде **CER**-файла из корневого ЦС или с любого устройства, доверенного корневому ЦС, и назначьте его устройствам, используя профиль сертификата доверенного ЦС.<br /><br />Для каждой платформы операционной системы используется один доверенный корневой сертификат ЦС, который связывается с каждым созданным профилем доверенного корневого сертификата.<br /><br />При необходимости можно использовать дополнительные доверенные корневые сертификаты ЦС. Например, это можно сделать, чтобы предоставить доверие ЦС, подписывающему сертификаты проверки подлинности сервера для точек доступа Wi-Fi.|

### <a name="accounts"></a>Учетные записи

|Название|Подробные сведения|
|--------|-----------|
|**Учетная запись службы NDES**|Введите учетную запись пользователя домена для использования в качестве учетной записи службы NDES.|

## <a name="configure-your-infrastructure"></a>Настройка инфраструктуры
Перед настройкой профилей сертификатов выполните описанные ниже задачи. Эти задачи предполагают, что вы знакомы с Windows Server 2012 R2 и службами сертификатов Active Directory (ADCS):

**Шаг 1**. Создание учетной записи службы NDES.

**Шаг 2**. Настройка шаблонов сертификатов в центре сертификации.

**Шаг 3**. Настройка необходимых компонентов на сервере NDES.

**Шаг 4**. Настройка NDES для использования с Intune.

**Шаг 5**. Включение, установка и настройка соединителя сертификатов Intune.

#### <a name="step-1---create-an-ndes-service-account"></a>Шаг 1. Создание учетной записи службы NDES

Создайте учетную запись пользователя домена для использования в качестве учетной записи службы NDES. Эта учетная запись указывается при настройке шаблонов в выдающем ЦС перед установкой и настройкой NDES. Убедитесь, что пользователь имеет следующие права по умолчанию: **Локальный вход**, **Вход в качестве службы** и **Вход в качестве пакетного задания**. Некоторые организации имеют политики усиления защиты, которые отключают эти права.

#### <a name="step-2---configure-certificate-templates-on-the-certification-authority"></a>Шаг 2. Настройка шаблонов сертификатов в центре сертификации
В этой задаче вы:

- настроите шаблон сертификата для NDES;
- опубликуете шаблон сертификата для NDES.

##### <a name="configure-the-certification-authority"></a>Настройка центра сертификации

1. Войдите в систему в качестве администратора предприятия.

2. В выдающем ЦС создайте пользовательский шаблон с помощью оснастки "Шаблоны сертификатов". Или скопируйте существующий шаблон и затем обновите его (например, шаблон пользователя) для использования в NDES.

   >[!NOTE]
   > Шаблон сертификата NDES должен быть основан на шаблоне сертификата версии 2 (с совместимостью с Windows 2003).

   Шаблон должен иметь следующие настройки.

   - Укажите понятное **отображаемое имя шаблона**.

   - На вкладке **Имя субъекта** выберите **Supply in the request** (Предоставляется в запросе). (Безопасность обеспечивается модулем политики Intune для NDES.)

   - На вкладке **Расширения** включите в раздел **Описание политик приложений** пункт **Проверка подлинности клиента**.

     > [!IMPORTANT]
     > Для шаблонов сертификатов iOS и macOS измените на вкладке **Расширения** параметр **Использование ключа** и снимите флажок **Подпись подтверждает подлинность**.

   - На вкладке **Безопасность** добавьте учетную запись службы NDES и предоставьте ей разрешения **Регистрация** для шаблона. Администраторам Intune, которые создают профили SCEP, требуются права на **Чтение**, чтобы они могли просматривать шаблон при создании профилей SCEP.

     > [!NOTE]
     > Для отзыва сертификатов учетной записи службы NDES требуются права *Выдача сертификатов и управление ими* для каждого шаблона сертификата, используемого профилем сертификата.

3. Просмотрите **Период действия** на вкладке **Общие** шаблона. По умолчанию в Intune используется значение, настроенное в шаблоне. Однако в настройках ЦС вы можете разрешить инициатору запроса вводить другое значение, которое можно затем задать в консоли администрирования Intune. Если вы хотите всегда использовать значение в шаблоне, пропустите остальные действия этого шага.

   > [!IMPORTANT]
   > Системы iOS и macOS всегда используют значение, заданное в шаблоне, невзирая на другие настройки.

Пример конфигурации шаблона

![Шаблон, вкладка "Обработка запроса"](./media/scep_ndes_request_handling.png)

![Шаблон, вкладка "Имя субъекта"](./media/scep_ndes_subject_name.jpg)

![Шаблон, вкладка "Безопасность"](./media/scep_ndes_security.jpg)

![Шаблон, вкладка "Расширения"](./media/scep_ndes_extensions.jpg)

![Шаблон, вкладка "Требования выдачи"](./media/scep_ndes_issuance_reqs.jpg)

> [!IMPORTANT]
> Для политик приложения добавьте только необходимые политики. Согласуйте выбранные параметры с администраторами безопасности.

Настройте ЦС для разрешения инициатору запроса вводить период действия.

1. Выполните следующие команды в ЦС:
   - **certutil -setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE**
   - **net stop certsvc**
   - **net start certsvc**

2. В выдающем ЦС используйте оснастку центра сертификации, чтобы опубликовать шаблон сертификата.
   Выберите узел **Шаблоны сертификатов**, щелкните **Действие** > **Создать** > **Выдаваемый шаблон сертификата**, а затем укажите шаблон, созданный на шаге 2.

3. Убедитесь, что шаблон опубликован, просмотрев его в папке **Шаблоны сертификата** .

#### <a name="step-3---configure-prerequisites-on-the-ndes-server"></a>Шаг 3. Настройка необходимых компонентов на сервере NDES
В этой задаче вы:

- добавите NDES к Windows Server и настроите в IIS поддержку NDES;
- добавите учетную запись службы NDES в группу IIS_IUSR;
- настроите SPN для учетной записи службы NDES.

1. На сервере, где размещается NDES, выполните вход в качестве **администратора предприятия**, а затем используйте [мастер добавления ролей и компонентов](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831809(v=ws.11)) для установки NDES.

   1. В мастере выберите **Службы сертификатов Active Directory** , чтобы получить доступ к службам ролей служб сертификатов Active Directory. Выберите **Служба регистрации сертификатов для сетевых устройств**, снимите флажок **Центр сертификации**, а затем завершите работу мастера.

      > [!TIP]
      > В разделе **Ход выполнения установки** не нажимайте кнопку **Закрыть**. Вместо этого щелкните ссылку **Настроить службы сертификатов Active Directory на конечном сервере**. Откроется мастер **настройки служб сертификатов Active Directory**, который будет использоваться для следующей задачи. После того, как откроется окно настройки служб сертификатов Active Directory, можно закрыть мастер добавления ролей и компонентов.

   2. При добавлении NDES на сервер мастер также установит IIS. Убедитесь, что в IIS настройки заданы следующим образом:

   3. **Веб-сервер** > **Безопасность** > **Фильтрация запросов**

   4. **Веб-сервер** > **Разработка приложений** > **ASP.NET 3.5**. При установке ASP.NET 3.5 устанавливается платформа .NET Framework 3.5. При установке .NET Framework 3.5 установите основной компонент **.NET Framework 3.5** и компонент **Активация по HTTP**.

   5. **Веб-сервер** > **Разработка приложений** > **ASP.NET 4.5**. При установке ASP.NET 4.5 устанавливается платформа .NET Framework 4.5. При установке .NET Framework 4.5 установите основной компонент **.NET Framework 4.5**, компонент **ASP.NET 4.5** и компонент **Службы WCF** > **Активация по HTTP**.

   6. **Средства управления** > **Совместимость управления IIS 6** > **Совместимость метабазы IIS 6**

   7. **Средства управления** > **Совместимость управления IIS 6** > **Совместимость WMI в IIS 6**

   8. На сервере добавьте учетную запись службы NDES в качестве участника группы **IIS_IUSR**.

2. Выполните следующую команду, чтобы настроить SPN для учетной записи службы NDES:

    `setspn -s http/<DNS name of NDES Server> <Domain name>\<NDES Service account name>`

    Например, если имя сервера NDES — **Server01**, домен — **Contoso.com**, а учетная запись службы — **NDESService**, используйте:

    `setspn –s http/Server01.contoso.com contoso\NDESService`

#### <a name="step-4---configure-ndes-for-use-with-intune"></a>Шаг 4. Настройка NDES для использования с Intune
В этой задаче вы:

- настроите NDES для использования с выдающим ЦС;
- привяжете сертификат проверки подлинности сервера (SSL-сертификат) в IIS;
- настроите фильтрацию запросов в IIS.

1. На сервере NDES откройте мастер настройки служб сертификатов Active Directory и внесите следующие изменения.

    > [!TIP]
    > Если вы щелкнули ссылку в предыдущей задаче, этот мастер будет уже открыт. В противном случае откройте диспетчер серверов, чтобы получить доступ к настройке служб сертификатов Active Directory после развертывания.

   - На странице **Службы ролей** выберите **Служба регистрации сертификатов для сетевых устройств**.
   - На странице **Учетная запись службы для NDES** укажите учетную запись службы NDES.
   - На странице **ЦС для NDES** щелкните **Выбрать** и укажите выдающий ЦС, в котором настроен шаблон сертификата.
   - На странице **Криптография для NDES** задайте длину ключа, соответствующую требованиям компании.
   - На странице **Подтверждение** щелкните **Настроить**, чтобы завершить работу мастера.

2. После завершения работы мастера измените следующий раздел реестра на сервере NDES:

    `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MSCEP\`

    Чтобы обновить этот раздел, определите **назначение** шаблона сертификата (на его вкладке **Обработка запроса**). Затем обновите соответствующую запись реестра, заменив существующие данные именем шаблона сертификата (не отображаемым именем шаблона), указанным в задаче 1. Следующая таблица содержит соответствия назначений шаблона сертификата и значений в реестре:

    |Назначение шаблона сертификата (на вкладке "Обработка запросов")|Изменяемое значение реестра|Значение, отображающееся в консоли администрирования Intune для профиля SCEP|
    |---|---|---|
    |Подпись|SignatureTemplate|Цифровая подпись|
    |Encryption|EncryptionTemplate|Шифрование ключа|
    |Подпись и шифрование|GeneralPurposeTemplate|Шифрование ключа<br/>Цифровая подпись|

    Например, если назначение шаблона сертификата — **Шифрование**, измените значение **EncryptionTemplate** на имя шаблона сертификата.

3. Сервер NDES получает длинные URL-адреса (запросы), для которых необходимо добавить две записи реестра:


   |                        Расположение                        |      Значение      | Type  |      Миграция       |
   |--------------------------------------------------------|-----------------|-------|-----------------|
   | HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters | MaxFieldLength  | DWORD | 65534 (десятичное число) |
   | HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters | MaxRequestBytes | DWORD | 65534 (десятичное число) |


4. В диспетчере IIS выберите **Веб-сайт по умолчанию** > **Фильтрация запросов** > **Изменить параметры функций**. Измените значение параметров **Максимальная длина URL-адреса** и **Максимальная длина строки запроса** на *65534*, как показано далее.

    ![Максимальная длина URL-адреса IIS и длина запроса](./media/SCEP_IIS_max_URL.png)

5. Перезагрузите сервер. Для завершения этих изменений недостаточно выполнить команду **iisreset** на сервере.
6. Перейдите к `http://*FQDN*/certsrv/mscep/mscep.dll`. Вы должны увидеть страницу NDES, аналогичную следующей:

    ![Проверка NDES](./media/SCEP_NDES_URL.png)

    Если вы получаете ответ **503 — служба недоступна**, проверьте средство просмотра событий. Вполне вероятно, что пул приложений остановлен из-за отсутствия прав у пользователя NDES. Эти права описаны в Задаче 1.

##### <a name="install-and-bind-certificates-on-the-ndes-server"></a>Установка и привязка сертификатов на сервере NDES

1. На сервере NDES запросите и установите сертификат **проверки подлинности сервера** из внутреннего или общедоступного ЦС. Затем этот SSL-сертификат привязывается в IIS.

    > [!TIP]
    > После привязки SSL-сертификата в службах IIS установите сертификат проверки подлинности клиента. Этот сертификат может выдать любой ЦС, которому доверяет сервер NDES. Хотя это не рекомендуется, тот же сертификат можно использовать для проверки подлинности как сервера, так и клиента, если этот сертификат имеет оба расширенных использования ключа (EKU). Дополнительные сведения об этих сертификатах проверки подлинности см. в следующих шагах.

   1. После получения сертификата проверки подлинности сервера откройте **диспетчер IIS** и выберите **Веб-сайт по умолчанию**. В области **Действия** щелкните элемент **Привязки**.

   2. Нажмите кнопку **Добавить**, задайте для пункта **Тип** значение **https**, а затем укажите порт **443**. Для автономной службы Intune поддерживается только порт 443.

   3. В поле **SSL-сертификат** укажите сертификат проверки подлинности сервера.

      > [!NOTE]
      > Если сервер NDES использует внешнее и внутреннее имена для одного сетевого адреса, сертификат проверки подлинности сервера должен иметь:
      > - **имя субъекта** с внешним общедоступным именем сервера;
      > - **альтернативное имя субъекта**, включающее внутреннее имя сервера.

2. На сервере NDES запросите и установите сертификат **проверки подлинности клиента** из внутреннего или общедоступного ЦС. Это может быть тот же сертификат, что и сертификат проверки подлинности сервера, если этот сертификат поддерживает обе возможности.

    Сертификат проверки подлинности клиента должен иметь следующие свойства:

    - **Расширенное использование ключа**. Это значение должно включать **Проверку подлинности клиента**.

    - **Имя субъекта**. Это значение должно совпадать с DNS-именем сервера, на котором устанавливается сертификат (сервер NDES).

##### <a name="configure-iis-request-filtering"></a>Настройка фильтрации запросов IIS

1. На сервере NDES откройте **диспетчер IIS**, на панели **Подключения** выберите **Веб-сайт по умолчанию**, а затем откройте вкладку **Фильтрация запросов**.

2. Щелкните **Изменить параметры функций** и задайте следующие значения:

    - **строка запроса (в байтах)** = **65534**
    - **Максимальная длина URL-адреса (байт)** = **65534**

3. Проверьте следующий раздел реестра:

    `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HTTP\Parameters`

    Убедитесь, что в качестве записей DWORD установлены следующие значения:

    - Имя: **MaxFieldLength**с десятичным значением **65 534**
    - Имя: **MaxRequestBytes**с десятичным значением **65 534**

4. Перезагрузите NDES-сервер. Сервер теперь поддерживает соединитель сертификатов.

#### <a name="step-5---enable-install-and-configure-the-intune-certificate-connector"></a>Шаг 5. Включение, установка и настройка соединителя сертификатов Intune
В этой задаче вы:

- включите поддержку NDES в Intune;
- скачаете, установите и настроите соединитель сертификатов на сервере с ролью службы регистрации сертификатов для сетевых устройств (NDES) в вашей среде. Чтобы увеличить масштаб реализации NDES в организации, можно установить несколько серверов NDES, а на каждом из них — Microsoft Intune Certificate Connector.

##### <a name="download-install-and-configure-the-certificate-connector"></a>Скачивание, установка и настройка соединителя сертификатов
![ConnectorDownload](./media/certificates-download-connector.png)

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Все службы**, отфильтруйте список по **Intune** и выберите **Microsoft Intune**.
3. Выберите **Конфигурация устройства**, а затем — **Центр сертификации**.
4. Нажмите кнопку **Добавить** и щелкните ссылку **Скачать файл соединителя**. Сохраните файл в расположении, в котором вы сможете открыть его с сервера, на котором выполняется установка.
5. После скачивания запустите установщик (**ndesconnectorssetup.exe**) на сервере, на котором находится роль службы регистрации сертификатов для сетевых устройств (NDES). Также будет установлен модуль политики для NDES и веб-службы CRP. (Веб-служба CRP, CertificateRegistrationSvc, выполняется в IIS как приложение.)

    > [!NOTE]
    > При установке NDES для автономной службы Intune служба CRP автоматически устанавливается вместе с соединителем сертификатов. При использовании Intune с Configuration Manager точка регистрации сертификатов устанавливается как отдельная роль системы сайта.

6. При запросе сертификата клиента для соединителя сертификатов щелкните **Выбрать** и укажите сертификат **проверки подлинности клиента**, установленный на сервере NDES в задаче 3.

    После выбора сертификата проверки подлинности клиента вы вернетесь на поверхность **Сертификата клиента для соединителя сертификатов Microsoft Intune** . Хотя выбранный сертификат не отображается, нажмите кнопку **Далее**, чтобы просмотреть свойства этого сертификата. После этого нажмите кнопки **Далее** и **Установить**.

7. После завершения работы мастера, но перед тем, как закрыть его, щелкните **Запустить пользовательский интерфейс соединителя сертификатов**.

    > [!TIP]
    > Если вы закроете мастер перед запуском пользовательского интерфейса соединителя сертификатов, вы можете повторно открыть его, выполнив следующую команду:
    >
    > <путь_установки> \NDESConnectorUI\NDESConnectorUI.exe

8. В пользовательском интерфейсе **соединителя сертификатов** :

    Щелкните **Войти** и введите учетные данные администратора службы Intune или учетные данные администратора клиента с разрешениями глобального администратора.

    > [!IMPORTANT]
    > Учетной записи пользователя должна быть назначена действительная лицензия Intune. Если у учетной записи пользователя нет действительной лицензии Intune, программа NDESConnectorUI.exe завершит работу со сбоем.

    Если ваша организация использует прокси-сервер и он требуется для подключения сервера NDES к Интернету, выберите пункт **Использовать прокси-сервер** и введите имя, порт и учетные данные учетной записи прокси-сервера для подключения.

    Откройте вкладку **Дополнительно**, а затем введите учетные данные учетной записи с разрешением **Выдача сертификатов и управление ими** в выдающем центре сертификации. Нажмите кнопку **Применить**, чтобы применить изменения.

    Теперь можно закрыть пользовательский интерфейс соединителя сертификатов.

9. Откройте командную строку, введите **services.msc**, а затем нажмите клавишу **Ввод**. Щелкните правой кнопкой мыши элемент **Служба соединителя Intune** и выберите пункт **Перезапустить**.

Чтобы убедиться, что служба работает, откройте браузер и введите следующий URL-адрес. Он должен вернуть ошибку **403**.

`http://<FQDN_of_your_NDES_server>/certsrv/mscep/mscep.dll`

## <a name="create-a-scep-certificate-profile"></a>Создание профиля сертификата SCEP

1. На портале Azure откройте Microsoft Intune.
2. Последовательно выберите **Конфигурация устройства**, **Профили** и **Создать профиль**.
3. Введите **имя** и **описание** профиля сертификата SCEP.
4. Из раскрывающегося списка **Платформа** выберите платформу устройств для этого сертификата SCEP. В настоящее время для параметров ограничения устройства можно выбрать одну из следующих платформ.
   - **Android**
   - **iOS**
   - **macOS**
   - **Windows Phone 8.1**
   - **Windows 8.1 и более поздние версии**
   - **Windows 10 и более поздних версий**.
5. В раскрывающемся списке **Тип профиля** выберите **Сертификат SCEP**.
6. На панели **Сертификат SCEP** настройте следующие параметры:

   - **Срок действия сертификата**. Запустив на выдающем ЦС команду `certutil - setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE`, которая позволяет использовать настраиваемый срок действия, вы можете ввести оставшееся время до истечения срока действия сертификата.<br>Можно указать значение ниже, но не выше периода действия в шаблоне сертификата. Например, если в шаблоне сертификата указан срок действия сертификата в два года, можно ввести значение в один год, но не в пять лет. Кроме того, значение не должно превышать значение оставшегося периода действия сертификата, выдаваемого центром сертификации. 
   - **Поставщик хранилища ключей (KSP)** (Windows Phone 8.1, Windows 8.1, Windows 10). Укажите, где хранится ключ для сертификата. Выберите одно из следующих значений:
     - **Зарегистрировать в KSP доверенного платформенного модуля (TPM) при его наличии, в противном случае зарегистрировать в KSP программного обеспечения**.
     - **Зарегистрировать в KSP доверенного платформенного модуля (TPM), в противном случае создать сбой**.
     - **Зарегистрировать в паспорте, в противном случае создать сбой (Windows 10 и более поздних версий)**.
     - **Зарегистрировать в KSP программного обеспечения**.

   - **Формат имени субъекта**. Выберите в списке способ, с помощью которого Intune автоматически создает имя субъекта в запросе на сертификат. Если сертификат предназначен для пользователя, в имя субъекта можно также включить адрес электронной почты пользователя. Выберите один из следующих типов.
     - **Не настроено**.
     - **Обычное имя**.
     - **Обычное имя с адресом электронной почты**.
     - **Обычное имя как адрес электронной почты**.
     - **IMEI (международный идентификатор мобильного оборудования)**
     - **Серийный номер**
     - **Другой**. При выборе этого параметра появляется дополнительное поле с раскрывающимся списком. В этом поле можно ввести настраиваемый формат имени субъекта. Настраиваемый формат поддерживает две переменные: **Общее имя (CN)** или **Электронная почта (E)**. В качестве **общего имени (CN)** можно задать любую из следующих переменных.
       - **CN={{UserName}}**. Имя субъекта-пользователя, например janedoe@contoso.com.
       - **CN={{AAD_Device_ID}}**. ИД, назначенный при регистрации устройства в Azure Active Directory (AD). Как правило, он используется для проверки подлинности в Azure AD.
       - **CN={{SERIALNUMBER}}**. Уникальный серийный номер (SN), обычно используемый изготовителем для идентификации устройства.
       - **CN={{IMEINumber}}**. Уникальный номер международного идентификатора мобильного оборудования (IMEI), используемый для идентификации мобильного телефона.
       - **CN={{OnPrem_Distinguished_Name}}**. Последовательность относительных различающихся имен, разделенных запятыми, например `CN=Jane Doe,OU=UserAccounts,DC=corp,DC=contoso,DC=com`.

          Чтобы использовать переменную `{{OnPrem_Distinguished_Name}}`, необходимо синхронизировать атрибут пользователя `onpremisesdistingishedname` с Azure AD с помощью [Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect).

       - **CN={{onPremisesSamAccountName}}**. Администраторы могут синхронизировать атрибут samAccountName из Active Directory в Azure AD с помощью Azure AD Connect в атрибут с именем `onPremisesSamAccountName`. Intune может заменить эту переменную как часть запроса на выдачу сертификата в субъекте сертификата SCEP.  Атрибут samAccountName — это имя пользователя для входа, используемое для поддержки клиентов и серверов предыдущей версии Windows (до Windows 2000). Формат имени пользователя для входа: `DomainName\testUser` или только `testUser`.

          Чтобы использовать переменную `{{onPremisesSamAccountName}}`, необходимо синхронизировать атрибут пользователя `onPremisesSamAccountName` с Azure AD с помощью [Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect).

       Используя сочетание одной или нескольких этих переменных и статических строк, можно создать пользовательский формат имени субъекта, например: **CN={{UserName}},E={{EmailAddress}},OU=Mobile,O=Finance Group,L=Redmond,ST=Washington,C=US**. <br/> В этом примере создан формат имени субъекта, который, кроме переменных CN и E, использует строки для определения подразделения, организации, расположения, штата и страны. Эта функция и поддерживаемые ею строки отписываются в статье [Функция CertStrToName](https://msdn.microsoft.com/library/windows/desktop/aa377160.aspx).

- **Альтернативное имя субъекта**. Укажите способ, с помощью которого Intune автоматически создает значения для альтернативного имени субъекта в запросе на сертификат. Например, если вы выбираете тип сертификата пользователя, в альтернативное имя субъекта можно включить имя субъекта-пользователя. Если сертификат клиента используется для проверки подлинности сервера политики сети, в качестве альтернативного имени субъекта необходимо задать имя участника-пользователя.
- **Использование ключа**. Введите параметры использования ключа для сертификата. Доступны следующие параметры:
  - **Шифрование ключей**. Обмен ключами разрешается, только если они зашифрованы.
  - **Цифровая подпись**. Обмен ключами разрешается, только если они защищены с помощью цифровой подписи.
- **Размер ключа (разрядов)**. Выберите количество битов, которое содержится в ключе.
- **Хэш-алгоритм** (Android, Windows Phone 8.1, Windows 8.1, Windows 10). Используйте с этим сертификатом один из доступных типов хэш-алгоритмов. Выберите максимальный уровень безопасности, который поддерживают подключающиеся устройства.
- **Корневой сертификат**. Выберите профиль корневого сертификата ЦС, настроенный ранее и назначенный пользователю или устройству. Этот сертификат ЦС должен быть корневым сертификатом ЦС, который выдает сертификат, настраиваемый в данном профиле сертификата.
- **Расширенное использование ключа**. Выберите **Добавить**, чтобы добавить значения для назначения сертификата. В большинстве случаев для сертификата требуется **проверка подлинности клиента**, чтобы пользователь или устройство могли выполнить проверку подлинности на сервере. Однако при необходимости можно добавить любые другие варианты использования ключа.
- **Параметры регистрации**
  - **Renewal threshold (%)** (Порог обновления (%)). Введите процент времени существования сертификата, который остается, прежде чем устройство запросит его возобновление.
  - **URL-адреса сервера SCEP**. Введите один или несколько URL-адресов для серверов NDES, которые выдают сертификаты через SCEP.
  - Нажмите кнопки **ОК** и **Создать**, чтобы создать профиль.

Созданный профиль отобразится на панели со списком профилей.

## <a name="assign-the-certificate-profile"></a>Назначение профиля сертификата

Прежде чем назначать группам профили сертификатов, необходимо учесть следующее:

- При назначении профилей сертификатов группам на устройстве устанавливается файл сертификата из профиля сертификата доверенного ЦС. Устройство использует профиль сертификата SCEP для создания запроса на сертификат устройством.
- Профили сертификата устанавливаются на устройствах только той платформы, которую вы использовали при создании профиля.
- Можно назначать профили сертификатов и для коллекции пользователей, и для устройств.
- Чтобы опубликовать сертификат на устройстве сразу после регистрации, назначьте профиль сертификата в группе пользователей, а не в группе устройств. Если вы назначаете профиль группе устройств, требуется полная регистрация устройства для получения политик.
- Хотя каждый профиль и назначается отдельно, вам потребуется доверенный корневой ЦС, а также профиль SCEP или PKCS. В противном случае произойдет сбой политики сертификата SCEP или PKCS.

    > [!NOTE]
    > При развертывании нескольких профилей ресурсов, использующих один профиль сертификата, в iOS вы увидите несколько копий сертификата в профиле управления.
    
Дополнительные сведения см. в статье о [назначении профилей устройств](device-profile-assign.md).
