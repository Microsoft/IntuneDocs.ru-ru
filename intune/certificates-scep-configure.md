---
title: Использование сертификатов SCEP в Microsoft Intune в Azure | Документы Майкрософт
description: Для использования сертификатов SCEP в Microsoft Intune следует настроить локальный домен AD, создать центр сертификации, настроить сервер NDES и установить Intune Certificate Connector. Затем нужно создать профиль сертификата SCEP и назначить его группам. Кроме того, просмотрите идентификаторы различных событий и их описания, а также диагностические коды для службы соединителя Intune.
keywords: ''
author: brenduns
ms.author: brenduns
manager: dougeby
ms.date: 06/28/2019
ms.topic: conceptual
ms.service: microsoft-intune
ms.localizationpriority: high
ms.technology: ''
ms.reviewer: lacranda
ms.suite: ems
search.appverid: MET150
ms.custom: intune-azure
ms.collection: M365-identity-device-management
ms.openlocfilehash: 97612a8d169295d9ec28d230fb6f37a0be8ce324
ms.sourcegitcommit: 6b5907046f920279bbda3ee6c93e98594624c05c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2019
ms.locfileid: "69582962"
---
# <a name="configure-and-use-scep-certificates-with-intune"></a>Настройка и использование сертификатов SCEP в Intune

В этой статье показано, как настроить инфраструктуру, а затем создать и назначить профили сертификатов SCEP (Simple Certificate Enrollment Protocol) с помощью Intune.

## <a name="configure-on-premises-infrastructure"></a>Настройка локальной инфраструктуры

- **Домен Active Directory**. Все серверы, указанные в этом разделе (за исключением сервера прокси-службы веб-приложения), должны быть присоединены к домену Active Directory.

- **Центр сертификации** (ЦС). Требуется центр сертификации предприятия (Майкрософт) под управлением выпуска Enterprise Windows Server 2008 R2 или более поздней версии. Автономный ЦС не поддерживается. Дополнительные сведения см. в разделе [Установка центра сертификации](https://technet.microsoft.com/library/jj125375.aspx).
    Если ЦС выполняется под управлением Windows Server 2008 R2, необходимо [установить исправление из KB2483564](http://support.microsoft.com/kb/2483564/).

- **Сервер NDES**. На сервере Windows Server 2012 R2 или более поздней версии настройте роль сервера "Служба регистрации сертификатов для сетевых устройств" (NDES). Intune не поддерживает использование службы NDES на сервере, где также запущен ЦС предприятия. Инструкции по настройке Windows Server 2012 R2 для размещения службы NDES см. в разделе [Руководство по службе регистрации сертификатов для сетевых устройств](https://technet.microsoft.com/library/hh831498.aspx).
Сервер NDES должен быть присоединен к домену в том же лесу, что и ЦС предприятия. Дополнительные сведения о развертывании сервера NDES в отдельном лесу, изолированной сети или на внутреннем домене можно найти в разделе [Использование модуля политики совместно со службой регистрации сертификатов для сетевых устройств](https://technet.microsoft.com/library/dn473016.aspx). Нельзя использовать сервер NDES, который уже используется с другой системой MDM.

- **Соединитель Microsoft Intune Certificate Connector**. На портале Intune перейдите в раздел **Конфигурация устройства** > **Соединители сертификатов** > **Добавить** и выполните *процедуру установки соединителя для SCEP*. Используйте ссылку на портале, чтобы начать загрузку установщика соединителя сертификатов **NDESConnectorSetup.exe**.  Вы будете запускать этот установщик на сервере с ролью NDES.  

Этот соединитель сертификатов NDES также поддерживает режим федерального стандарта обработки информации (FIPS). Режим FIPS не является обязательным, но когда он включен, вы можете выдавать и отменять сертификаты.

- **Сервер прокси-службы веб-приложения** (необязательно). Используйте сервер под управлением Windows Server 2012 R2 или более поздней версии в качестве сервера прокси-службы веб-приложения (WAP). Эта конфигурация:
  - позволяет устройствам получать сертификаты, используя подключение к Интернету;
  - является рекомендацией по безопасности, если устройства подключаются к Интернету для получения или возобновления действия сертификатов.
  
- **Azure AD Application Proxy** (необязательно). Вместо отдельного сервера прокси-службы веб-приложения (WAP) можно использовать Azure AD Application Proxy, чтобы открыть доступ к серверу NDES через Интернет. Дополнительные сведения см. в статье [Как обеспечить безопасный удаленный доступ к локальным приложениям](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy).

### <a name="additional"></a>Дополнительно

- На сервере, где размещается WAP, [необходимо установить обновление](http://blogs.technet.com/b/ems/archive/2014/12/11/hotfix-large-uri-request-in-web-application-proxy-on-windows-server-2012-r2.aspx) , обеспечивающее поддержку длинных URL-адресов, которые используются службой регистрации сертификатов для сетевых устройств. Это обновление включено в [накопительный пакет обновления за декабрь 2014 г.](http://support.microsoft.com/kb/3013769), или его можно получить отдельно из [KB3011135](http://support.microsoft.com/kb/3011135).
- Сервер WAP должен иметь SSL-сертификат, совпадающий с именем, опубликованным для внешних клиентов, и доверять SSL-сертификату, который используется на сервере NDES. Эти сертификаты позволяют WAP-серверу разорвать SSL-соединение клиентов и создать новое SSL-соединение с сервером NDES.

См. дополнительные сведения о [планировании сертификатов для WAP](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn383650(v=ws.11)#plan-certificates) и [серверах WAP](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn584113(v=ws.11)).

### <a name="network-requirements"></a>Требования к сети

Если вы не используете обратный прокси-сервер, например WAP или Azure AD Application Proxy, разрешите трафик TCP по порту 443 со всех узлов и IP-адресов в Интернете на сервер NDES.

Разрешите все необходимые порты и протоколы между сервером NDES и любой вспомогательной инфраструктурой. Например, серверу NDES необходимо взаимодействовать с ЦС, серверами DNS, серверами Configuration Manager, контроллерами домена и, возможно, другими службами в вашей среде.

Настоятельно рекомендуется публиковать сервер NDES через обратный прокси-сервер, например через [Azure AD Application Proxy](https://azure.microsoft.com/documentation/articles/active-directory-application-proxy-publish/), [прокси веб-доступа](https://technet.microsoft.com/library/dn584107.aspx) или прокси-сервер стороннего поставщика.

### <a name="certificates-and-templates"></a>Сертификаты и шаблоны  

|Объект|Подробные сведения|
|----------|-----------|
|**Шаблон сертификата**|Настройте этот шаблон в выдающем ЦС.|
|**Сертификат проверки подлинности клиента**|Сертификат, запрошенный из выдающего или общедоступного ЦС, устанавливается на сервере NDES.|
|**Сертификат проверки подлинности сервера**|SSL-сертификат, запрошенный из выдающего или общедоступного ЦС, устанавливается и привязывается в IIS на сервере NDES. Если сертификат имеет набор вариантов использования ключа проверки подлинности клиента и сервера (**Расширенное использование ключа**), можно использовать тот же сертификат.|
|**Доверенный корневой сертификат ЦС**|Экспортируйте этот сертификат в виде **CER**-файла из корневого ЦС или с любого устройства, доверяющего корневому ЦС. Затем назначьте его пользователям, устройствам (или и тем, и другим) с помощью профиля сертификата доверенного ЦС.<br /> **Примечание<br />. При назначении профиля сертификата SCEP не забудьте назначить *профиль доверенного корневого сертификата*, на который указывает ссылка, тому же пользователю или той же группе устройств.  Чтобы создать этот профиль, ознакомьтесь с разделом [Создание профиля доверенного сертификата](certficates-pfx-configure.md#create-a-trusted-certificate-profile) в статье о профилях сертификатов PKCS.** <br/><br />Для каждой платформы операционной системы используется один доверенный корневой сертификат ЦС, который связывается с каждым созданным профилем доверенного корневого сертификата. <br /><br />При необходимости можно использовать дополнительные доверенные корневые сертификаты ЦС. Например, это можно сделать, чтобы предоставить доверие ЦС, подписывающему сертификаты проверки подлинности сервера для точек доступа Wi-Fi.|

### <a name="accounts"></a>Учетные записи

|Название|Подробные сведения|
|--------|-----------|
|**Учетная запись службы NDES**|Введите учетную запись пользователя домена для использования в качестве учетной записи службы NDES. |

## <a name="configure-your-infrastructure"></a>Настройка инфраструктуры
Перед настройкой профилей сертификатов выполните описанные ниже шаги. Эти инструкции предполагают, что вы знакомы с Windows Server 2012 R2 и более поздних версий и службами сертификатов Active Directory (ADCS):

### <a name="step-1---create-an-ndes-service-account"></a>Шаг 1. Создание учетной записи службы NDES

Создайте учетную запись пользователя домена для использования в качестве учетной записи службы NDES. Эта учетная запись указывается при настройке шаблонов в выдающем ЦС перед установкой и настройкой NDES. Убедитесь, что пользователь имеет следующие права по умолчанию: **Локальный вход**, **Вход в качестве службы** и **Вход в качестве пакетного задания**. Некоторые организации имеют политики усиления защиты, которые отключают эти права.

### <a name="step-2---configure-certificate-templates-on-the-certification-authority"></a>Шаг 2. Настройка шаблонов сертификатов в центре сертификации
В этом шаге вы сделаете следующее:

- настроите шаблон сертификата для NDES;
- опубликуете шаблон сертификата для NDES.

#### <a name="configure-the-certification-authority"></a>Настройка центра сертификации

1. Войдите в систему в качестве администратора предприятия.

2. В выдающем ЦС создайте пользовательский шаблон с помощью оснастки "Шаблоны сертификатов". Или скопируйте существующий шаблон и затем обновите его (например, шаблон пользователя) для использования в NDES.

   >[!NOTE]
   > Шаблон сертификата NDES должен быть основан на шаблоне сертификата версии 2 (с совместимостью с Windows 2003).

   Шаблон должен иметь следующие настройки.

   - На вкладке **Общие**, сделайте следующее:
   
       - Убедитесь, что **не** установлен флажок **Опубликовать сертификат в Active Directory**.
       - Укажите понятное **отображаемое имя шаблона**.

   - На вкладке **Имя субъекта** выберите **Supply in the request** (Предоставляется в запросе). (Безопасность обеспечивается модулем политики Intune для NDES.)

   - На вкладке **Расширения** включите в раздел **Описание политик приложений** пункт **Проверка подлинности клиента**.

     > [!IMPORTANT]
     > Для шаблонов сертификатов iOS и macOS измените на вкладке **Расширения** параметр **Использование ключа** и снимите флажок **Подпись подтверждает подлинность**.

   - На вкладке **Безопасность** добавьте учетную запись службы NDES и предоставьте ей разрешения **Регистрация** для шаблона. Администраторам Intune, которые создают профили SCEP, требуются права на **Чтение**, чтобы они могли просматривать шаблон при создании профилей SCEP.

     > [!NOTE]
     > Для отзыва сертификатов учетной записи службы NDES требуются права *Выдача сертификатов и управление ими* для центра сертификации. Чтобы делегировать это разрешение, откройте консоль управления центром сертификации и щелкните правой кнопкой мыши имя центра сертификации. Затем на вкладке "Безопасность" добавьте или выберите учетную запись и установите флажок **Выдача сертификатов и управление ими**.


3. Просмотрите **Период действия** на вкладке **Общие** шаблона. По умолчанию в Intune используется значение, настроенное в шаблоне. Но в настройках ЦС вы можете разрешить инициатору запроса вводить другое значение, которое можно затем задать в консоли администрирования Intune. Если вы хотите всегда использовать значение в шаблоне, пропустите остальные действия на этом этапе.

   > [!IMPORTANT]
   > Системы iOS и macOS всегда используют значение, заданное в шаблоне, невзирая на другие настройки.

Пример конфигурации шаблона

![Шаблон, вкладка "Обработка запроса"](./media/scep_ndes_request_handling.png)

![Шаблон, вкладка "Имя субъекта"](./media/scep_ndes_subject_name.jpg)

![Шаблон, вкладка "Безопасность"](./media/scep_ndes_security.jpg)

![Шаблон, вкладка "Расширения"](./media/scep_ndes_extensions.jpg)

![Шаблон, вкладка "Требования выдачи"](./media/scep_ndes_issuance_reqs.jpg)

> [!IMPORTANT]
> Для политик приложения добавьте только необходимые политики. Согласуйте выбранные параметры с администраторами безопасности.

Настройте ЦС для разрешения инициатору запроса вводить период действия.

1. Выполните следующие команды в ЦС:
   - **certutil -setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE**
   - **net stop certsvc**
   - **net start certsvc**

2. В выдающем ЦС используйте оснастку центра сертификации, чтобы опубликовать шаблон сертификата.
   Выберите узел **Шаблоны сертификатов**, щелкните **Действие** > **Создать** > **Выдаваемый шаблон сертификата**, а затем укажите шаблон, созданный на шаге 2.

3. Убедитесь, что шаблон опубликован, просмотрев его в папке **Шаблоны сертификата** .

### <a name="step-3---configure-prerequisites-on-the-ndes-server"></a>Шаг 3. Настройка необходимых компонентов на сервере NDES
В этом шаге вы сделаете следующее:

- добавите NDES к Windows Server и настроите в IIS поддержку NDES;
- добавите учетную запись службы NDES в группу IIS_IUSR;
- Задание имени субъекта-службы для учетной записи службы NDES

1. На сервере, где размещается NDES, выполните вход в качестве **администратора предприятия**, а затем используйте [мастер добавления ролей и компонентов](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831809(v=ws.11)) для установки NDES.

   1. В мастере выберите **Службы сертификатов Active Directory** , чтобы получить доступ к службам ролей служб сертификатов Active Directory. Выберите **Служба регистрации сертификатов для сетевых устройств**, снимите флажок **Центр сертификации**, а затем завершите работу мастера.

      > [!TIP]
      > В разделе **Ход выполнения установки** не нажимайте кнопку **Закрыть**. Вместо этого щелкните ссылку **Настроить службы сертификатов Active Directory на конечном сервере**. Откроется мастер **настройки служб сертификатов Active Directory**, который будет использоваться для следующей задачи. После того, как откроется окно настройки служб сертификатов Active Directory, можно закрыть мастер добавления ролей и компонентов.

   2. При добавлении NDES на сервер мастер также установит IIS. Убедитесь, что в IIS настройки заданы следующим образом:

       - **Веб-сервер** > **Безопасность** > **Фильтрация запросов**

       - **Веб-сервер** > **Разработка приложений** > **ASP.NET 3.5**. 

            При установке ASP.NET 3.5 устанавливается платформа .NET Framework 3.5. При установке .NET Framework 3.5 установите основной компонент **.NET Framework 3.5** и компонент **Активация по HTTP**.

       - **Веб-сервер** > **Разработка приложений** > **ASP.NET 4.5**. 

            При установке ASP.NET 4.5 устанавливается платформа .NET Framework 4.5. При установке .NET Framework 4.5 установите основной компонент **.NET Framework 4.5**, компонент **ASP.NET 4.5** и компонент **Службы WCF** > **Активация по HTTP**.

       - **Средства управления** > **Совместимость управления IIS 6** > **Совместимость метабазы IIS 6**

       - **Средства управления** > **Совместимость управления IIS 6** > **Совместимость WMI в IIS 6**

       - На сервере добавьте учетную запись службы NDES в качестве участника локальной группы **IIS_IUSR**.

2. Выполните следующую команду, чтобы настроить SPN для учетной записи службы NDES:

    `setspn -s http/<DNS name of NDES Server> <Domain name>\<NDES Service account name>`

    Например, если имя сервера NDES — **Server01**, домен — **Contoso.com**, а учетная запись службы — **NDESService**, используйте:

    `setspn –s http/Server01.contoso.com contoso\NDESService`

### <a name="step-4---configure-ndes-for-use-with-intune"></a>Шаг 4. Настройка NDES для использования с Intune
В этом шаге вы сделаете следующее:

- настроите NDES для использования с выдающим ЦС;
- привяжете сертификат проверки подлинности сервера (SSL-сертификат) в IIS;
- настроите фильтрацию запросов в IIS.

1. На сервере NDES откройте мастер настройки служб сертификатов Active Directory и внесите следующие изменения.

    > [!TIP]
    > Если вы щелкнули ссылку в предыдущем шаге, этот мастер будет уже открыт. В противном случае откройте диспетчер серверов, чтобы получить доступ к настройке служб сертификатов Active Directory после развертывания.

   - На странице **Службы ролей** выберите **Служба регистрации сертификатов для сетевых устройств**.
   - На странице **Учетная запись службы для NDES** укажите учетную запись службы NDES.
   - На странице **ЦС для NDES** щелкните **Выбрать** и укажите выдающий ЦС, в котором настроен шаблон сертификата.
   - На странице **Криптография для NDES** задайте длину ключа, соответствующую требованиям компании.
   - На странице **Подтверждение** щелкните **Настроить**, чтобы завершить работу мастера.

2. После завершения работы мастера измените следующий раздел реестра на сервере NDES:

    `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MSCEP\`

    Чтобы обновить этот раздел, определите **назначение** шаблона сертификата (на его вкладке **Обработка запроса**). Затем обновите соответствующую запись реестра, заменив существующие данные именем шаблона сертификата (не отображаемым именем шаблона), указанным в шаге 2. Следующая таблица содержит соответствия назначений шаблона сертификата и значений в реестре:

    |Назначение шаблона сертификата (на вкладке "Обработка запросов")|Изменяемое значение реестра|Значение, отображающееся в консоли администрирования Intune для профиля SCEP|
    |---|---|---|
    |Подпись|SignatureTemplate|Цифровая подпись|
    |Encryption|EncryptionTemplate|Шифрование ключа|
    |Подпись и шифрование|GeneralPurposeTemplate|Шифрование ключа<br/>Цифровая подпись|

    Например, если назначение шаблона сертификата — **Шифрование**, измените значение **EncryptionTemplate** на имя шаблона сертификата.

3. Сервер NDES получает длинные URL-адреса (запросы), для которых необходимо добавить две записи реестра:


   |                        Расположение                        |      Значение      | Type  |      Миграция       |
   |--------------------------------------------------------|-----------------|-------|-----------------|
   | HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters | MaxFieldLength  | DWORD | 65534 (десятичное число) |
   | HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters | MaxRequestBytes | DWORD | 65534 (десятичное число) |

4. В диспетчере IIS выберите **Веб-сайт по умолчанию** > **Фильтрация запросов** > **Изменить параметры функций**. Измените значение параметров **Максимальная длина URL-адреса** и **Максимальная длина строки запроса** на *65534*, как показано далее.

    ![Максимальная длина URL-адреса IIS и длина запроса](./media/SCEP_IIS_max_URL.png)

5. Перезагрузите сервер. Не выполняйте команду **iisreset**, так как она не позволяет завершить эти изменения.
6. Перейдите к `http://*FQDN*/certsrv/mscep/mscep.dll`. Вы должны увидеть страницу NDES, аналогичную следующей:

    ![Проверка NDES](./media/SCEP_NDES_URL.png)

    Если вы получаете ответ **503 — служба недоступна**, проверьте средство просмотра событий. Вполне вероятно, что пул приложений остановлен из-за отсутствия прав у пользователя NDES. Эти права описаны в шаге 1.

#### <a name="install-and-bind-certificates-on-the-ndes-server"></a>Установка и привязка сертификатов на сервере NDES

1. На сервере NDES запросите и установите сертификат **проверки подлинности сервера** из внутреннего или общедоступного ЦС. Затем этот SSL-сертификат привязывается в IIS.

    > [!TIP]
    > После привязки SSL-сертификата в службах IIS установите сертификат проверки подлинности клиента. Этот сертификат может выдать любой ЦС, которому доверяет сервер NDES. Можно использовать тот же сертификат, если сертификат имеет набор вариантов использования ключа проверки подлинности клиента и сервера (**Расширенное использование ключа**). Дополнительные сведения об этих сертификатах проверки подлинности см. в следующих шагах.

   1. После получения сертификата проверки подлинности сервера откройте **диспетчер IIS** и выберите **Веб-сайт по умолчанию**. В области **Действия** выберите элемент **Привязки**.

   2. Нажмите кнопку **Добавить**, задайте для пункта **Тип** значение **https**, а затем укажите порт **443**. Для автономной службы Intune поддерживается только порт 443.

   3. В поле **SSL-сертификат** укажите сертификат проверки подлинности сервера.

      > [!NOTE]
      > Если сервер NDES использует внешнее и внутреннее имена для одного сетевого адреса, сертификат проверки подлинности сервера должен иметь:
      > - **имя субъекта** с внешним общедоступным именем сервера;
      > - **альтернативное имя субъекта**, включающее внутреннее имя сервера.

2. На сервере NDES запросите и установите сертификат **проверки подлинности клиента** из внутреннего или общедоступного ЦС. Это может быть тот же сертификат, что и сертификат проверки подлинности сервера, если этот сертификат поддерживает обе возможности.

    Сертификат проверки подлинности клиента должен иметь следующие свойства:

    - **Расширенное использование ключа**: Это значение должно включать **проверку подлинности клиента**.

    - **Имя субъекта**. Значение должно совпадать с DNS-именем сервера, на котором устанавливается сертификат (сервер NDES).

#### <a name="configure-iis-request-filtering"></a>Настройка фильтрации запросов IIS

1. На сервере NDES откройте **диспетчер IIS**, на панели **Подключения** выберите **Веб-сайт по умолчанию**, а затем откройте вкладку **Фильтрация запросов**.

2. Щелкните **Изменить параметры функций** и задайте следующие значения:

    - **строка запроса (в байтах)**  = **65534**
    - **Максимальная длина URL-адреса (байт)**  = **65534**

3. Проверьте следующий раздел реестра:

    `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HTTP\Parameters`

    Убедитесь, что в качестве записей DWORD установлены следующие значения:

    - Имя. **MaxFieldLength** с десятичным значением **65534**.
    - Имя. **MaxRequestBytes** с десятичным значением **65534**.

4. Перезагрузите NDES-сервер. Сервер теперь поддерживает соединитель сертификатов.

### <a name="step-5---enable-install-and-configure-the-intune-certificate-connector"></a>Шаг 5. Включение, установка и настройка соединителя сертификатов Intune
В этом шаге вы сделаете следующее:

- включите поддержку NDES в Intune;
- скачаете, установите и настроите соединитель сертификатов на сервере с ролью службы регистрации сертификатов для сетевых устройств (NDES) в вашей среде. Чтобы увеличить масштаб реализации NDES в организации, можно установить несколько серверов NDES, а на каждом из них — Microsoft Intune Certificate Connector.

#### <a name="download-install-and-configure-the-certificate-connector"></a>Скачивание, установка и настройка соединителя сертификатов

> [!IMPORTANT] 
> Microsoft Intune Certificate Connector **необходимо** установить на отдельный сервер Windows. Этот соединитель нельзя установить на компьютер с выдающим центром сертификации (ЦС). Он также **должен** быть установлен на сервер с ролью службы регистрации сертификатов для сетевых устройств (NDES).

1. Войдите в [Intune](https://go.microsoft.com/fwlink/?linkid=2090973).
2. Выберите **Конфигурация устройства** > **Соединители сертификации** > **Добавить**.
3. Скачайте и сохраните файл соединителя для SCEP файла. Сохраните его в расположении, доступном с сервера NDES, на который вы собираетесь установить соединитель.

   ![ConnectorDownload](./media/certificates-scep-configure/download-certificates-connector.png)


4. После скачивания перейдите на сервер NDES, где размещается служба регистрации сертификатов для сетевых устройств (NDES). Затем сделайте следующее:

    1. Убедитесь, что установлена среда .NET 4.5 Framework, так как она необходима для соединителя сертификатов NDES. .NET 4.5 Framework автоматически входит в состав Windows Server 2012 R2 и более новых версий.
    2. Используйте учетную запись с правами администратора на сервере, чтобы запустить установщик (**NDESConnectorSetup.exe**). Также будет установлен модуль политики для NDES и веб-службы CRP. Веб-служба CRP, CertificateRegistrationSvc, выполняется в IIS как приложение.

    > [!NOTE]
    > При установке NDES для автономной службы Intune служба CRP автоматически устанавливается вместе с соединителем сертификатов. При использовании Intune с Configuration Manager точка регистрации сертификатов устанавливается как отдельная роль системы сайта.

5. При запросе сертификата клиента для соединителя сертификатов щелкните **Выбрать** и укажите сертификат **проверки подлинности клиента**, установленный на сервере NDES в шаге 4.

    После выбора сертификата проверки подлинности клиента вы вернетесь на поверхность **Сертификата клиента для соединителя сертификатов Microsoft Intune** . Хотя выбранный сертификат не отображается, нажмите кнопку **Далее**, чтобы просмотреть свойства этого сертификата. После этого нажмите кнопки **Далее** и **Установить**.

    > [!IMPORTANT]
    > Конфигурацию усиленной безопасности Internet Explorer [необходимо отключить на сервере NDES](https://technet.microsoft.com/library/cc775800(v=WS.10).aspx), где размещается соединитель Intune Certificate Connector.

6. После завершения работы мастера, но перед тем, как закрыть его, щелкните **Запустить пользовательский интерфейс соединителя сертификатов**.

    > [!TIP]
    > Если вы закроете мастер перед запуском пользовательского интерфейса соединителя сертификатов, вы можете повторно открыть его, выполнив следующую команду:
    >
    > <путь_установки>\NDESConnectorUI\NDESConnectorUI.exe

7. В пользовательском интерфейсе **соединителя сертификатов** :

    Щелкните **Войти** и введите учетные данные администратора службы Intune или учетные данные администратора клиента с разрешениями глобального администратора. После входа в систему Intune Certificate Connector загружает сертификат из Intune. Этот сертификат используется для проверки подлинности между соединителем и Intune.

    > [!IMPORTANT]
    > Учетной записи пользователя должна быть назначена действительная лицензия Intune. Если у учетной записи пользователя нет действительной лицензии Intune, программа NDESConnectorUI.exe завершит работу со сбоем.

    Если ваша организация использует прокси-сервер и он требуется для подключения сервера NDES к Интернету, выберите пункт **Использовать прокси-сервер**. Затем введите имя прокси-сервера, порт и учетные данные учетной записи для подключения.

    Откройте вкладку **Дополнительно**, а затем введите учетные данные учетной записи с разрешением **Выдача сертификатов и управление ими** в выдающем центре сертификации. Нажмите кнопку **Применить**, чтобы применить изменения. Если это разрешение было делегировано в учетную запись службы NDES при [настройке центра сертификации](#configure-the-certification-authority), укажите эту учетную запись здесь. 

    Теперь можно закрыть пользовательский интерфейс соединителя сертификатов.

8. Откройте командную строку, введите **services.msc**, а затем нажмите клавишу **Ввод**. Щелкните правой кнопкой мыши **Служба соединителя Intune** > **Перезапустить**.

Чтобы убедиться, что служба работает, откройте браузер и введите следующий URL-адрес. Он должен вернуть ошибку **403**.

`http://<FQDN_of_your_NDES_server>/certsrv/mscep/mscep.dll`

> [!NOTE]
> Поддержка TLS 1.2 входит в состав соединителя сертификатов NDES. Если сервер с установленным соединителем сертификатов NDES поддерживает TLS 1.2, то используется TLS 1.2. Если сервер не поддерживает TLS 1.2, то используется TLS 1.1. Сейчас TLS 1.1 используется для проверки подлинности между устройствами и сервером.

## <a name="create-a-scep-certificate-profile"></a>Создание профиля сертификата SCEP

1. Войдите в [Intune](https://go.microsoft.com/fwlink/?linkid=2090973).
2. Выберите **Конфигурация устройства** > **Профили** > **Создать профиль**.
3. Введите **имя** и **описание** профиля сертификата SCEP.
4. Из раскрывающегося списка **Платформа** выберите платформу устройств для этого сертификата SCEP. В настоящее время для параметров ограничения устройства можно выбрать одну из следующих платформ.
   - **Android**
   - **Android Enterprise**
   - **iOS**
   - **macOS**
   - **Windows Phone 8.1**
   - **Windows 8.1 и более поздние версии**
   - **Windows 10 и более поздних версий**.
5. В раскрывающемся списке **Тип профиля** выберите **Сертификат SCEP**.
6. Введите следующие параметры:

   - **Тип сертификата**. Выберите **Пользовательский** для пользовательских сертификатов. Тип сертификата **Пользователь** может содержать в субъекте или SAN атрибуты как пользователя, так и устройства.  Выбирайте тип **Устройство** в таких случаях, как использование устройств без участия пользователя (например, информационные киоски), или для устройств Windows, размещая сертификат в хранилище сертификатов локального компьютера. Тип сертификата **Устройство** может содержать в субъекте или SAN только атрибуты устройства.  Сертификаты типа **Устройство** доступны для следующих платформ:  
     - Android Enterprise — рабочий профиль
     - iOS
     - macOS
     - Windows 8.1 и более поздние версии
     - Windows 10 и более поздней версии


   - **Формат имени субъекта**. Выберите способ, с помощью которого Intune автоматически создает имя субъекта в запросе на сертификат. При выборе типа сертификата **Пользовательский** или **Устройство** параметры изменяются.  

     > [!NOTE]  
     > Существует [известная ошибка](#avoid-certificate-signing-requests-with-escaped-special-characters), связанная с использованием SCEP для получения сертификатов, когда имя субъекта в итоговом запросе на подпись сертификата (CSR) включает один из следующих экранируемых символов, перед которыми используется символ обратной косой черты (\\):
     > - \+
     > - ;
     > - ,
     > - =

        **Тип пользовательского сертификата**  

        В имя субъекта можно включить адрес электронной почты пользователя. Выберите один из следующих типов.

        - **Не настроено**.
        - **Обычное имя**.
        - **Обычное имя с адресом электронной почты**.
        - **Обычное имя как адрес электронной почты**.
        - **IMEI (международный идентификатор мобильного оборудования)**
        - **Серийный номер**
        - **Настраиваемый**. При выборе этого параметра также отображается текстовое поле **Настраиваемый**. В этом поле можно ввести настраиваемый формат имени субъекта с переменными. Настраиваемый формат поддерживает две переменные: **общее имя (CN)** и **адрес электронной почты (E)** . В качестве **общего имени (CN)** можно задать любую из следующих переменных.

            - **CN={{UserName}}** . Имя участника-пользователя, например janedoe@contoso.com.
            - **CN={{AAD_Device_ID}}** . ИД, назначенный при регистрации устройства в Azure Active Directory (AD). Как правило, он используется для проверки подлинности в Azure AD.
            - **CN={{SERIALNUMBER}}** . Уникальный серийный номер (SN), обычно используемый изготовителем для идентификации устройства.
            - **CN={{IMEINumber}}** . Уникальный номер международного идентификатора мобильного оборудования (IMEI), используемый для идентификации мобильного телефона.
            - **CN={{OnPrem_Distinguished_Name}}** . Последовательность относительных различающихся имен, разделенных запятыми, например `CN=Jane Doe,OU=UserAccounts,DC=corp,DC=contoso,DC=com`.

                Чтобы использовать переменную `{{OnPrem_Distinguished_Name}}`, необходимо синхронизировать атрибут пользователя `onpremisesdistingishedname` с Azure AD с помощью [Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect).

            - **CN={{onPremisesSamAccountName}}** . Администраторы могут синхронизировать атрибут samAccountName из Active Directory в Azure AD с помощью Azure AD Connect в атрибут с именем `onPremisesSamAccountName`. Intune может заменить эту переменную как часть запроса на выдачу сертификата в субъекте сертификата SCEP.  Атрибут samAccountName — это имя пользователя для входа, используемое для поддержки клиентов и серверов предыдущей версии Windows (до Windows 2000). Формат имени пользователя для входа: `DomainName\testUser` или только `testUser`.

                Чтобы использовать переменную `{{onPremisesSamAccountName}}`, необходимо синхронизировать атрибут пользователя `onPremisesSamAccountName` с Azure AD с помощью [Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect).

            Используя сочетание одной или нескольких этих переменных и статических строк, можно создать настраиваемый формат имени субъекта, как показано ниже:  

            **CN={{UserName}},E={{EmailAddress}},OU=Mobile,O=Finance Group,L=Redmond,ST=Washington,C=US**

            В этом примере создан формат имени субъекта, который, кроме переменных CN и E, использует строки для определения подразделения, организации, расположения, штата и страны или региона. Эта функция и поддерживаемые ею строки отписываются в статье [Функция CertStrToName](https://msdn.microsoft.com/library/windows/desktop/aa377160.aspx).

        **Тип сертификата устройства**  

        Если выбран тип сертификата **Устройство**, также в качестве значения можно использовать следующие переменные сертификата устройства:  

        ```
        "{{AAD_Device_ID}}",
        "{{Device_Serial}}",
        "{{Device_IMEI}}",
        "{{SerialNumber}}",
        "{{IMEINumber}}",
        "{{AzureADDeviceId}}",
        "{{WiFiMacAddress}}",
        "{{IMEI}}",
        "{{DeviceName}}",
        "{{FullyQualifiedDomainName}}",
        "{{MEID}}",
        ```

        Эти переменные можно добавить как статический текст в настраиваемое текстовое поле. Например, обычное имя можно добавить в виде `CN = {{DeviceName}}text`.

        > [!IMPORTANT]
        >  - Если в статическом тексте субъекта есть фигурные скобки **{ }** , не содержащие переменной, это приведет к ошибке. 
        >  - Используемую переменную сертификата устройства необходимо заключать в фигурные скобки **{ }** .
        >  - `{{FullyQualifiedDomainName}}` работает только на устройствах Windows и устройствах, присоединенных к домену. 
        >  - При использовании свойств устройства, таких как номер IMEI, серийный номер и полное доменное имя, в субъекте или SAN для сертификата устройства, имейте в виду, что эти свойства могут быть подделаны пользователем, имеющим доступ к устройству.
        >  - Профиль не будет установлен на устройство, если указанные переменные устройства не поддерживаются. Например если {{IMEI}} используется в качестве имени субъекта профиля SCEP для устройства, не имеющего номера IMEI, установка профиля завершится ошибкой. 


   - **Альтернативное имя субъекта**. Задайте способ, с помощью которого Intune автоматически создает значения для альтернативного имени субъекта в запросе на сертификат. При выборе типа сертификата **Пользовательский** или **Устройство** параметры изменяются. 

        **Тип пользовательского сертификата**  

        Доступны следующие атрибуты:

        - Адрес электронной почты
        - Имя субъекта-пользователя (UPN)

            Например, если вы выбираете тип сертификата пользователя, в альтернативное имя субъекта можно включить имя субъекта-пользователя. Если сертификат клиента будет использоваться для проверки подлинности сервера политики сети, в качестве альтернативного имени субъекта необходимо задать имя участника-пользователя. 

        **Тип сертификата устройства**  

        Поддерживающее настройку текстовое поле формата таблицы. Доступны следующие атрибуты:

        - DNS

        Для типа сертификата **Устройство** в качестве значения можно использовать следующие переменные сертификата устройства:  

        ```
        "{{AAD_Device_ID}}",
        "{{Device_Serial}}",
        "{{Device_IMEI}}",
        "{{SerialNumber}}",
        "{{IMEINumber}}",
        "{{AzureADDeviceId}}",
        "{{WiFiMacAddress}}",
        "{{IMEI}}",
        "{{DeviceName}}",
        "{{FullyQualifiedDomainName}}",
        "{{MEID}}",
        ```

        Эти переменные можно добавить как статический текст в настраиваемое текстовое поле. Например, атрибут DNS можно добавить в виде `DNS name = {{AzureADDeviceId}}.domain.com`.

        > [!IMPORTANT]
        >  - В статическом тексте SAN не используются фигурные скобки **{ }** , вертикальная черта **|** и точка с запятой **;** . 
        >  - Используемую переменную сертификата устройства необходимо заключать в фигурные скобки **{ }** .
        >  - `{{FullyQualifiedDomainName}}` работает только на устройствах Windows и устройствах, присоединенных к домену. 
        >  - При использовании свойств устройства, таких как номер IMEI, серийный номер и полное доменное имя, в субъекте или SAN для сертификата устройства, имейте в виду, что эти свойства могут быть подделаны пользователем, имеющим доступ к устройству.
        >  - Профиль не будет установлен на устройство, если указанные переменные устройства не поддерживаются. Например если {{IMEI}} используется в качестве альтернативного имени субъекта профиля SCEP для устройства, не имеющего номера IMEI, установка профиля завершится ошибкой.  

   - **Срок действия сертификата**. Запустив на выдающем ЦС команду `certutil - setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE`, которая позволяет использовать настраиваемый срок действия, вы можете ввести оставшееся время до истечения срока действия сертификата.<br>Можно указать значение ниже, но не выше периода действия в шаблоне сертификата. Например, если в шаблоне сертификата указан срок действия сертификата в два года, можно ввести значение в один год, но не в пять лет. Кроме того, значение не должно превышать значение оставшегося периода действия сертификата, выдаваемого центром сертификации. 
   - **Поставщик хранилища ключей** (Windows Phone 8.1, Windows 8.1, Windows 10). Укажите место, где хранится ключ для сертификата. Выберите одно из следующих значений:
     - **Зарегистрировать в KSP доверенного платформенного модуля (TPM) при его наличии, в противном случае зарегистрировать в KSP программного обеспечения**.
     - **Зарегистрировать в KSP доверенного платформенного модуля (TPM), в противном случае создать сбой**.
     - **Зарегистрировать в паспорте, в противном случае создать сбой (Windows 10 и более поздних версий)** .
     - **Зарегистрировать в KSP программного обеспечения**.

   - **Использование ключа**. Введите параметры использования ключа для сертификата. Доступны следующие параметры:
     - **Шифрование ключей**. Обмен ключами разрешается, только если они зашифрованы.
     - **Цифровая подпись**. Обмен ключами разрешается, только если они защищены с помощью цифровой подписи.
   - **Размер ключа (разрядов)** . Выберите количество битов, которое содержится в ключе.
   - **Хэш-алгоритм** (Android, Windows Phone 8.1, Windows 8.1, Windows 10). Используйте с этим сертификатом один из доступных типов хэш-алгоритмов. Выберите максимальный уровень безопасности, который поддерживают подключающиеся устройства.
   - **Корневой сертификат**. Выберите [профиль доверенного корневого сертификата](certficates-pfx-configure.md#create-a-trusted-certificate-profile), настроенный ранее и назначенный пользователю и (или) устройству. Этот сертификат ЦС должен быть корневым сертификатом ЦС, который выдает сертификат, настраиваемый в данном профиле сертификата. Не забудьте назначить этот профиль доверенного корневого сертификата той же группе, которая указана в профиле сертификата SCEP.
   - **Расширенное использование ключа**. Выберите **Добавить**, чтобы добавить значения для назначения сертификата. В большинстве случаев для сертификата требуется **проверка подлинности клиента**, чтобы пользователь или устройство могли выполнить проверку подлинности на сервере. Однако при необходимости можно добавить любые другие варианты использования ключа.
   - **Параметры регистрации**
     - **Renewal threshold (%)** (Порог обновления (%)). Введите процент времени существования сертификата, который остается, прежде чем устройство запросит его возобновление.
     - **URL-адреса серверов SCEP**. Введите один или несколько URL-адресов для серверов NDES, которые выдают сертификаты через SCEP. Например, можно ввести адрес такого типа: `https://ndes.contoso.com/certsrv/mscep/mscep.dll`.
     - Нажмите кнопки **ОК** и **Создать**, чтобы создать профиль.

Созданный профиль отобразится на панели со списком профилей.

### <a name="avoid-certificate-signing-requests-with-escaped-special-characters"></a>Избегайте использования запросов на подпись сертификата со специальными экранируемыми символами
Существует известная ошибка, связанная с запросами на сертификат SCEP, когда имя субъекта содержит один или несколько экранируемых символов. Использование такого имени субъекта приведет к тому, что CSR распознает это имя как неправильное, что, в свою очередь, приведет к сбою проверки запросов SCEP в Intune и отсутствию сертификата.  

Специальные символы:
- \+
- ,
- ;
- =

Если имя субъекта содержит один из этих символов, вы можете выполнить одно из следующих действий:  
- заключить значение имени субъекта, содержащее специальный символ, в кавычки;  
- удалить специальный символ из значения имени субъекта.  

**Например**, у вас есть имя субъекта, которое отображается как *Test user (TestCompany, LLC)* .  CSR с именем субъекта, которое содержит *запятую* между *TestCompany* и LLC, представляет собой проблему.  Проблему можно решить, заключив в кавычки все имя субъекта или удалив запятую между *TestCompany* и *LLC*:
- **Добавление кавычек**: *CN=* "Test User (TestCompany, LLC)",OU=UserAccounts,DC=corp,DC=contoso,DC=com*
- **Удаление запятой**: *CN=Test User (TestCompany LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com*

 При этом попытки экранировать запятую с помощью символа обратной косой черты будут приводить к ошибке в журналах CRP:  
- **Экранированная запятая**: *CN=Test User (TestCompany\\, LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com*

Эта ошибка похожа на следующую ошибку: 

```
Subject Name in CSR CN="Test User (TESTCOMPANY\, LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com" and challenge CN=Test User (TESTCOMPANY\, LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com do not match  

  Exception: System.ArgumentException: Subject Name in CSR and challenge do not match

   at Microsoft.ConfigurationManager.CertRegPoint.ChallengeValidation.ValidationPhase3(PKCSDecodedObject pkcsObj, CertEnrollChallenge challenge, String templateName, Int32 skipSANCheck)

Exception:    at Microsoft.ConfigurationManager.CertRegPoint.ChallengeValidation.ValidationPhase3(PKCSDecodedObject pkcsObj, CertEnrollChallenge challenge, String templateName, Int32 skipSANCheck)

   at Microsoft.ConfigurationManager.CertRegPoint.Controllers.CertificateController.VerifyRequest(VerifyChallengeParams value
```



## <a name="assign-the-certificate-profile"></a>Назначение профиля сертификата

Прежде чем назначать группам профили сертификатов, необходимо учесть следующее:

- При назначении профилей сертификатов группам на устройстве устанавливается файл сертификата из профиля сертификата доверенного ЦС. Устройство использует профиль сертификата SCEP для создания запроса на сертификат устройством.
- Профили сертификата устанавливаются на устройствах только той платформы, которую вы использовали при создании профиля.
- Можно назначать профили сертификатов и для коллекции пользователей, и для устройств.
- Чтобы опубликовать сертификат на устройстве сразу после регистрации, назначьте профиль сертификата в группе пользователей, а не в группе устройств. Если вы назначаете профиль группе устройств, требуется полная регистрация устройства для получения политик.
- Хотя каждый профиль и назначается отдельно, вам потребуется доверенный корневой ЦС, а также профиль SCEP или PKCS. В противном случае произойдет сбой политики сертификата SCEP или PKCS.

    > [!NOTE]
    > На устройствах iOS, если профиль сертификата SCEP связан с дополнительным профилем, например Wi-Fi или VPN, устройство получает сертификат для каждого из этих профилей. Из-за этого запрос на сертификат SCEP получает множество сертификатов на iOS-устройствах.  

- Если вы используете совместное управление для Intune и Configuration Manager, в Configuration Manager [установите ползунок рабочей нагрузки](https://docs.microsoft.com/sccm/comanage/how-to-switch-workloads) для параметра *Resource Access Policy* (Политика доступа к ресурсам) напротив значения **Intune** или **Pilot Intune** (Пилотная версия Intune). Этот параметр позволяет клиентам Windows 10 запускать процесс запроса сертификата.  

Дополнительные сведения см. в статье о [назначении профилей устройств](device-profile-assign.md).

## <a name="intune-connector-setup-verification-and-troubleshooting"></a>Проверка установки соединителя Intune и устранение неполадок

Сведения об устранении неполадок и проверке установки соединителя Intune см. в разделе [Примеры сценариев для центра сертификации](https://aka.ms/intuneconnectorverificationscript)

## <a name="intune-connector-events-and-diagnostic-codes"></a>События и диагностические коды соединителя Intune

Начиная с версии 6.1806.x.x, служба соединителя Intune регистрирует события в компоненте **Просмотр событий** (**Журналы приложений и служб** > **Соединитель Microsoft Intune**). С помощью этих событий можно устранять возможные неполадки с конфигурацией соединителя Intune. В событиях отражается успешное выполнение или сбой операции, а также содержатся диагностические коды с сообщениями, помогающими ИТ-администратору в устранении неполадок.

### <a name="event-ids-and-descriptions"></a>Идентификаторы и описания событий

> [!NOTE]
> Сведения о диагностических кодах, связанных с каждым событием, см. в таблице **Диагностические коды** (в этой статье).

| Код события      | Имя события    | Описание события | Связанные диагностические коды |
| ------------- | ------------- | -------------     | -------------            |
| 10010 | StartedConnectorService  | Служба соединителя запущена. | 0x00000000, 0x0FFFFFFF |
| 10020 | StoppedConnectorService  | Служба соединителя остановлена. | 0x00000000, 0x0FFFFFFF |
| 10100 | CertificateRenewal_Success  | Сертификат регистрации соединителя успешно продлен. | 0x00000000, 0x0FFFFFFF |
| 10102 | CertificateRenewal_Failure  | Не удалось продлить сертификат регистрации соединителя. Переустановите соединитель. | 0x00000000, 0x00000405, 0x0FFFFFFF |
| 10302 | RetrieveCertificate_Error  | Не удалось получить сертификат регистрации соединителя из реестра. Просмотрите сведения об отпечатке сертификата, связанные с этим событием. | 0x00000000, 0x00000404, 0x0FFFFFFF |
| 10301 | RetrieveCertificate_Warning  | Просмотрите диагностические сведения в описании события. | 0x00000000, 0x00000403, 0x0FFFFFFF |
| 20100 | PkcsCertIssue_Success  | Сертификат PKCS успешно выдан. Просмотрите сведения об идентификаторе устройства, идентификаторе пользователя, имени ЦС, имени шаблона сертификата и отпечатке сертификата, связанные с этим событием. | 0x00000000, 0x0FFFFFFF |
| 20102 | PkcsCertIssue_Failure  | Не удалось выдать сертификат PKCS. Просмотрите сведения об идентификаторе устройства, идентификаторе пользователя, имени ЦС, имени шаблона сертификата и отпечатке сертификата, связанные с этим событием. | 0x00000000, 0x00000400, 0x00000401, 0x0FFFFFFF |
| 20200 | RevokeCert_Success  | Сертификат успешно отозван. Просмотрите сведения об идентификаторе устройства, идентификаторе пользователя, имени ЦС и серийном номере сертификата, связанные с этим событием. | 0x00000000, 0x0FFFFFFF |
| 20202 | RevokeCert_Failure | Не удалось отозвать сертификат. Просмотрите сведения об идентификаторе устройства, идентификаторе пользователя, имени ЦС и серийном номере сертификата, связанные с этим событием. Дополнительные сведения см. в журналах SVC службы регистрации сертификатов для сетевых устройств.   | 0x00000000, 0x00000402, 0x0FFFFFFF |
| 20300 | Upload_Success | Успешно переданы данные запроса или отзыва сертификата. Сведения об операции см. в описании события. | 0x00000000, 0x0FFFFFFF |
| 20302 | Upload_Failure | Не удалось передать данные запроса или отзыва сертификата. Чтобы определить точку сбоя, просмотрите состояние передачи в сведениях о событии.| 0x00000000, 0x0FFFFFFF |
| 20400 | Download_Success | Успешно скачан запрос на подписание сертификата, скачивание сертификата клиента или отзыв сертификата. Сведения об операции см. в описании события.  | 0x00000000, 0x0FFFFFFF |
| 20402 | Download_Failure | Не удалось скачать запрос на подписание сертификата, скачивание сертификата клиента или отзыв сертификата. Сведения об операции см. в описании события. | 0x00000000, 0x0FFFFFFF |
| 20500 | CRPVerifyMetric_Success  | Точка регистрации сертификатов успешно проверила запрос клиента. | 0x00000000, 0x0FFFFFFF |
| 20501 | CRPVerifyMetric_Warning  | Точка регистрации сертификатов выполнила, но отклонила запрос. Дополнительные сведения можно получить по диагностическому коду и в сообщении. | 0x00000000, 0x00000411, 0x0FFFFFFF |
| 20502 | CRPVerifyMetric_Failure  | Точке регистрации сертификатов не удалось проверить запрос клиента. Дополнительные сведения можно получить по диагностическому коду и в сообщении. Идентификатор устройства, соответствующий запросу, см. в сообщении о событии. | 0x00000000, 0x00000408, 0x00000409, 0x00000410, 0x0FFFFFFF |
| 20600 | CRPNotifyMetric_Success  | Точка регистрации сертификатов успешно завершила процесс уведомления и отправила сертификат на клиентское устройство. | 0x00000000, 0x0FFFFFFF |
| 20602 | CRPNotifyMetric_Failure  | Точке регистрации сертификатов не удалось завершить процесс уведомления. Подробные сведения о запросе см. в сообщении о событии. Проверьте соединение между сервером службы регистрации сертификатов для сетевых устройств и ЦС. | 0x00000000, 0x0FFFFFFF |

### <a name="diagnostic-codes"></a>Диагностические коды

| Диагностический код | Диагностическое имя | Диагностическое сообщение |
| -------------   | -------------   | -------------      |
| 0x00000000 | Успех  | Успех |
| 0x00000400 | PKCS_Issue_CA_Unavailable  | Центр сертификации недопустим или недоступен. Проверьте, доступен ли центр сертификации и может ли ваш сервер связаться с ним. |
| 0x00000401 | Symantec_ClientAuthCertNotFound  | Не удалось найти сертификат авторизации клиента Symantec в локальном хранилище сертификатов. Дополнительные сведения см. в статье [Set up Intune Certificate Connector for DigiCert PKI Platform](https://docs.microsoft.com/intune/certificates-digicert-configure#troubleshooting) (Настройка соединителя сертификатов Intune для платформы DigiCert PKI).  |
| 0x00000402 | RevokeCert_AccessDenied  | Указанная учетная запись не имеет разрешений на отзыв сертификата из ЦС. Чтобы определить выдающий ЦС, см. поле "Имя ЦС" в сообщении о событии.  |
| 0x00000403 | CertThumbprint_NotFound  | Не удалось найти сертификат, соответствующий входным данным. Зарегистрируйте соединитель сертификата и повторите попытку. |
| 0x00000404 | Certificate_NotFound  | Не удалось найти сертификат, соответствующий предоставленным входным данным. Повторно зарегистрируйте соединитель сертификата и повторите попытку. |
| 0x00000405 | Certificate_Expired  | Срок действия сертификата истек. Повторно зарегистрируйте соединитель сертификата, чтобы продлить сертификат, и повторите попытку. |
| 0x00000408 | CRPSCEPCert_NotFound  | Не удалось найти сертификат шифрования CRP. Проверьте, правильно ли настроены служба регистрации сертификатов для сетевых устройств и соединитель Intune. |
| 0x00000409 | CRPSCEPSigningCert_NotFound  | Не удалось извлечь сертификат для подписи. Проверьте, правильно ли настроена и запущена ли служба соединителя Intune. Кроме того, проверьте, успешно ли завершилось скачивание сертификата. |
| 0x00000410 | CRPSCEPDeserialize_Failed  | Не удалось десериализовать запрос службы регистрации сертификатов для сетевых устройств. Проверьте, правильно ли настроены служба регистрации сертификатов для сетевых устройств и соединитель Intune. |
| 0x00000411 | CRPSCEPChallenge_Expired  | Запрос отклонен из-за запроса сертификата с истекшим сроком действия. Клиентское устройство может повторить попытку после получения нового запроса с сервера управления. |
| 0x0FFFFFFFF | Unknown_Error  | Невозможно выполнить запрос из-за ошибки на стороне сервера. Повторите попытку. |

## <a name="next-steps"></a>Дальнейшие шаги

- [Используйте сертификаты PKCS](certficates-pfx-configure.md) или [выдайте сертификаты PKCS из веб-службы диспетчера PKI Symantec](certificates-symantec-configure.md)
- [Добавление стороннего центра сертификации для использования SCEP в Intune](certificate-authority-add-scep-overview.md)
- Дополнительные сведения можно найти в следующих руководствах:
  - [Устранение неполадок развертывания профилей сертификатов SCEP в Microsoft Intune.](https://support.microsoft.com/help/4457481)
  - [Устранение неполадок конфигурации NDES для использования с профилями сертификатов Microsoft Intune.](https://support.microsoft.com/help/4459540)
