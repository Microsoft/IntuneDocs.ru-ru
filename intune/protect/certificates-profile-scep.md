---
title: Использование профилей сертификатов SCEP в Microsoft Intune в Azure | Документация Майкрософт
description: Создание и назначение профилей сертификатов SCEP с помощью Microsoft Intune.
keywords: ''
author: brenduns
ms.author: brenduns
manager: dougeby
ms.date: 11/13/2019
ms.topic: conceptual
ms.service: microsoft-intune
ms.subservice: protect
ms.localizationpriority: high
ms.technology: ''
ms.reviewer: lacranda
ms.suite: ems
search.appverid: MET150
ms.custom: intune-azure
ms.collection: M365-identity-device-management
ms.openlocfilehash: 3cd153a4c602ba49a5b5135d1d6cb32a61f2668d
ms.sourcegitcommit: 47c9af81c385c7e893fe5a85eb79cf08e69e6831
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/25/2020
ms.locfileid: "77576518"
---
# <a name="create-and-assign-scep-certificate-profiles-in-intune"></a>Создание и назначение профилей сертификатов SCEP в Intune

После [настройки инфраструктуры](certificates-scep-configure.md) для поддержки сертификатов SCEP можно создать и затем назначить профили сертификатов SCEP пользователям и устройствам в Intune.

> [!IMPORTANT]  
> Перед созданием профилей сертификатов SCEP устройства, которые будут использовать профиль сертификата SCEP, должны доверять доверенному корневому центру сертификации (CA). Используйте *профиль доверенного сертификата* в Intune, чтобы подготовить доверенный корневой сертификат ЦС для пользователей и устройств. Сведения о профиле доверенного сертификата см. в разделах [Экспорт доверенного корневого сертификата ЦС](certificates-configure.md#export-the-trusted-root-ca-certificate) и [Создание профилей доверенных сертификатов](certificates-configure.md#create-trusted-certificate-profiles) в статье *Использование сертификатов для проверки подлинности в Intune*.


## <a name="create-a-scep-certificate-profile"></a>Создание профиля сертификата SCEP

1. Войдите в [центр администрирования диспетчера конечных точек (Майкрософт)](https://go.microsoft.com/fwlink/?linkid=2109431).

2. Выберите **Устройства** > **Профиль конфигурации** > **Создать профиль**.

3. Укажите следующие свойства.

4. Введите **имя** и **описание** профиля сертификата SCEP.

5. Из раскрывающегося списка **Платформа** выберите [поддерживаемую платформу устройств](certificates-configure.md#supported-platforms-and-certificate-profiles) для этого сертификата SCEP.

6. В раскрывающемся списке **Тип профиля** выберите **Сертификат SCEP**.  

   Для платформы **Android для бизнеса***тип профиля* делится на две категории: *Только владелец устройства* и *Только рабочий профиль*. Не забудьте выбрать правильный профиль сертификата SCEP для управляемых вами устройств.  

   Для профилей сертификатов SCEP типа *Только владелец устройства* установлены следующие ограничения:

   1. В разделе "Мониторинг" отчеты по сертификатам недоступны для профилей сертификатов SCEP владельца устройства.

   2. Вы не можете использовать Intune для отзыва сертификатов, которые были подготовлены профилями сертификатов SCEP для владельцев устройств. Вы можете управлять отзывом с помощью внешнего процесса или непосредственно с помощью центра сертификации. 

   4. На выделенных устройствах Android Enterprise профили сертификатов SCEP поддерживаются только для конфигурации сети Wi-Fi и проверки подлинности.  Эти профили на выделенных устройствах Android Enterprise не поддерживаются для проверки подлинности VPN или приложения.   

   
7. Выберите **Параметры** и введите следующие значения.

   - **Тип сертификата**.

     *(Область применения:  Android, Android Enterprise, iOS/iPadOS, macOS, Windows 8.1 и более поздних версий, Windows 10 и более поздних версий.)*

     Выберите тип в зависимости от того, как будет использоваться профиль сертификата:

     - **Пользователь** — тип сертификата *Пользователь* может содержать в субъекте или SAN атрибуты как пользователя, так и устройства.  
     - **Устройство**.  Тип сертификата *Устройство* может содержать в субъекте или SAN только атрибуты устройства.

       Используйте **Устройство** для таких сценариев, как устройства без пользователей, например киоски, или для устройств с Windows. На устройствах с Windows сертификат помещается в хранилище сертификатов локального компьютера.

   - **Формат имени субъекта**.

     Выберите способ, с помощью которого Intune автоматически создает имя субъекта в запросе на сертификат. Параметры для формата имени субъекта зависят от выбранного типа сертификата: **Пользователь** или **Устройство**.

     > [!NOTE]
     > Существует [известная ошибка](#avoid-certificate-signing-requests-with-escaped-special-characters), связанная с использованием SCEP для получения сертификатов, когда имя субъекта в итоговом запросе на подпись сертификата (CSR) включает один из следующих экранируемых символов, перед которыми используется символ обратной косой черты (\\):
     > - \+
     > - ;
     > - ,
     > - =

     - **Тип пользовательского сертификата**

       Параметры формата для *Формата имени субъекта* включают:

       - **Не настроено**.
       - **Обычное имя**.
       - **Обычное имя с адресом электронной почты**.
       - **Обычное имя как адрес электронной почты**.
       - **IMEI (международный идентификатор мобильного оборудования)**
       - **Серийный номер**
       - **Настраиваемый**. При выборе этого параметра также отображается текстовое поле **Настраиваемый**. В этом поле можно ввести настраиваемый формат имени субъекта с переменными. Настраиваемый формат поддерживает две переменные: **общее имя (CN)** и **адрес электронной почты (E)** . В качестве **общего имени (CN)** можно задать любую из следующих переменных.

         - **CN={{UserName}}** . Имя участника-пользователя, например janedoe@contoso.com.
         - **CN={{AAD_Device_ID}}** . ИД, назначенный при регистрации устройства в Azure Active Directory (AD). Как правило, он используется для проверки подлинности в Azure AD.
         - **CN={{SERIALNUMBER}}** . Уникальный серийный номер (SN), обычно используемый изготовителем для идентификации устройства.
         - **CN={{IMEINumber}}** . Уникальный номер международного идентификатора мобильного оборудования (IMEI), используемый для идентификации мобильного телефона.
         - **CN={{OnPrem_Distinguished_Name}}** . Последовательность относительных различающихся имен, разделенных запятой, например *CN=Jane Doe,OU=UserAccounts,DC=corp,DC=contoso,DC=com*.

           Чтобы использовать переменную *{{OnPrem_Distinguished_Name}}* , не забудьте синхронизировать атрибут пользователя *onpremisesdistinguishedname* с помощью [Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect) с вашим Azure AD.

         - **CN={{onPremisesSamAccountName}}** . Администраторы могут синхронизировать атрибут samAccountName из Active Directory в Azure AD с помощью Azure AD Connect в атрибут с именем *onPremisesSamAccountName*. Intune может заменить эту переменную как часть запроса на выдачу сертификата в субъекте сертификата. Атрибут samAccountName — это имя пользователя для входа, используемое для поддержки клиентов и серверов предыдущей версии Windows (до Windows 2000). Формат имени входа пользователя: *домен\пользователь* или просто *пользователь*.

            Чтобы использовать переменную *{{onPremisesSamAccountName}}* , не забудьте синхронизировать атрибут пользователя *onPremisesSamAccountName* с помощью [Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect) с вашим Azure AD.

         Используя сочетание одной или нескольких этих переменных и статических строк, можно создать настраиваемый формат имени субъекта, как показано ниже:  
         - **CN={{UserName}},E={{EmailAddress}},OU=Mobile,O=Finance Group,L=Redmond,ST=Washington,C=US**

         В этом примере приведен формат имени субъекта, который, кроме переменных CN и E, использует строки для определения подразделения, организации, расположения, штата и страны. Эта функция и поддерживаемые ею строки отписываются в статье [Функция CertStrToName](https://msdn.microsoft.com/library/windows/desktop/aa377160.aspx).

      - **Тип сертификата устройства**

        Параметры формата для формата имени субъекта включают переменные:

        - **{{AAD_Device_ID}}** или **{{AzureADDeviceId}}**  — любую из этих переменных можно использовать для идентификации устройства по его идентификатору Azure AD.
        - **{{Device_Serial}}**
        - **{{Device_IMEI}}**
        - **{{SerialNumber}}**
        - **{{IMEINumber}}**
        - **{{WiFiMacAddress}}**
        - **{{IMEI}}**
        - **{{DeviceName}}**
        - **{{FullyQualifiedDomainName}}** *(только для устройств с Windows и устройств, присоединенных к домену)*
        - **{{MEID}}**

        В текстовом поле можно указать эти переменные, за которыми следует текст переменной. Например, общее имя устройства с именем *Device1* можно добавить как **CN={{DeviceName}}Device1**.

        > [!IMPORTANT]
        > - При указании переменной заключите имя переменной в фигурные скобки { }, как показано в примере, чтобы избежать ошибки.  
        > - Свойства устройства, используемые в *субъекте* или *SAN* сертификата устройства, например **IMEI**, **SerialNumber** и **FullyQualifiedDomainName**, — это свойства, которые могут быть подменены пользователем с доступом к устройству.
        > - Устройство должно поддерживать все переменные, указанные в профиле сертификата, для установки этого профиля на данном устройстве.  Например, если **{{IMEI}}** используется в качестве имени субъекта профиля SCEP для устройства, не имеющего номера IMEI, установка профиля завершится ошибкой.

   - **Альтернативное имя субъекта**. Задайте способ, с помощью которого Intune автоматически создает альтернативное имя субъекта в запросе на сертификат. Параметры для SAN зависят от выбранного типа сертификата: **Пользователь** или **Устройство**.

      - **Тип пользовательского сертификата**

        Выберите из доступных атрибутов:

        - **Адрес электронной почты**
        - **Имя субъекта-пользователя (UPN)**

        Например, если вы выбираете тип сертификата пользователя, в альтернативное имя субъекта можно включить имя субъекта-пользователя. Если сертификат клиента будет использоваться для проверки подлинности сервера политики сети, в качестве альтернативного имени субъекта необходимо задать имя участника-пользователя.

      - **Тип сертификата устройства**

        Используйте раскрывающийся список **Атрибут** и выберите атрибут, назначьте **значение** и **добавьте** его в профиль сертификата. Можно добавить несколько значений, выбрав дополнительные атрибуты.

        Доступные атрибуты:

        - **Адрес электронной почты**
        - **Имя субъекта-пользователя (UPN)**
        - **DNS**

        Для типа сертификата *Устройство* в качестве значения можно использовать следующие переменные сертификата устройства:

        - **{{AAD_Device_ID}}** или **{{AzureADDeviceId}}**  — любую из этих переменных можно использовать для идентификации устройства по его идентификатору Azure AD.
        - **{{Device_Serial}}**
        - **{{Device_IMEI}}**
        - **{{SerialNumber}}**
        - **{{IMEINumber}}**
        - **{{WiFiMacAddress}}**
        - **{{IMEI}}**
        - **{{DeviceName}}**
        - **{{FullyQualifiedDomainName}}**
        - **{{MEID}}**

        Чтобы указать значение для атрибута, включите имя переменной в фигурные скобки, а затем добавьте текст для этой переменной. Например, можно добавить значение для атрибута DNS: **{{AzureADDeviceId}}.domain.com**, где *.domain.com* — это текст. Для пользователя с именем *User1* адрес электронной почты может выглядеть как {{FullyQualifiedDomainName}}User1@Contoso.com.

        > [!IMPORTANT]
        > - Используемую переменную сертификата устройства необходимо заключать в фигурные скобки { }.
        > - Не используйте фигурные скобки **{ }** , символы вертикальной черты **|** и точки с запятой **;** в тексте, который следует за переменной.
        > - Свойства устройства, используемые в *субъекте* или *SAN* сертификата устройства, например **IMEI**, **SerialNumber** и **FullyQualifiedDomainName**, — это свойства, которые могут быть подменены пользователем с доступом к устройству.
        > - Устройство должно поддерживать все переменные, указанные в профиле сертификата, для установки этого профиля на данном устройстве.  Например, если **{{IMEI}}** используется в SAN профиля SCEP для устройства, не имеющего номера IMEI, установка профиля завершится ошибкой.

   - **Срок действия сертификата**.

     Можно указать значение ниже, но не выше периода действия в шаблоне сертификата. Если вы настроили шаблон сертификата [для поддержки пользовательского значения, которое можно задать в консоли Intune](certificates-scep-configure.md#modify-the-validity-period-of-the-certificate-template), используйте этот параметр, чтобы указать оставшееся время до истечения срока действия сертификата.

     Например, если в шаблоне сертификата указан срок действия сертификата в два года, можно ввести значение в один год, но не в пять лет. Кроме того, значение не должно превышать значение оставшегося периода действия сертификата, выдаваемого центром сертификации.

   - **Поставщик хранилища ключей (KSP)** .

     *(Область применения:  Windows 8.1 и более поздних версий, Windows 10 и более поздних версий.)*

     Укажите место, где хранится ключ для сертификата. Выберите один из следующих вариантов:

     - **Зарегистрировать в KSP доверенного платформенного модуля (TPM) при его наличии, в противном случае зарегистрировать в KSP программного обеспечения**.
     - **Зарегистрировать в KSP доверенного платформенного модуля (TPM), в противном случае создать сбой**.
     - **Зарегистрировать в паспорте, в противном случае создать сбой (Windows 10 и более поздних версий)** .
     - **Зарегистрировать в KSP программного обеспечения**.

   - **Использование ключа**.

     Выберите параметры использования ключа для сертификата.

     - **Цифровая подпись**. Обмен ключами разрешается, только если они защищены с помощью цифровой подписи.
     - **Шифрование ключа**. Обмен ключами разрешается, только если они зашифрованы.

   - **Размер ключа (разрядов)** .

     Выберите количество битов, которое содержится в ключе.

   - **Хэш-алгоритм**.

     *(Область применения: Android, Android Enterprise, iOS, macOS, Windows Phone 8.1, Windows 8.1 и более поздних версий, Windows 10 и более поздних версий.)*

     Используйте с этим сертификатом один из доступных типов хэш-алгоритмов. Выберите максимальный уровень безопасности, который поддерживают подключающиеся устройства.

   - **Корневой сертификат**.

     Выберите *профиль доверенного сертификата*, который вы ранее настроили и назначили подходящим пользователям и устройствам для этого профиля сертификата SCEP. Используйте профиль доверенного сертификата для предоставления доверенного корневого сертификата ЦС пользователям и устройствам. Сведения о профиле доверенного сертификата см. в статье [Экспорт доверенного корневого сертификата ЦС](certificates-configure.md#export-the-trusted-root-ca-certificate) и [Создание профилей доверенных сертификатов](certificates-configure.md#create-trusted-certificate-profiles) в разделе *Использование сертификатов для проверки подлинности в Intune*. Если у вас есть корневой центр сертификации и выдающий центр сертификации, выберите профиль доверенного корневого сертификата, связанный с выдающим центром сертификации.

   - **Расширенное использование ключа**.

     Добавьте значения для назначения сертификата. В большинстве случаев для сертификата требуется *проверка подлинности клиента*, чтобы пользователь или устройство могли пройти проверку подлинности на сервере. При необходимости можно добавить дополнительные сведения об использовании ключа.

   - **Порог обновления (%)** .

     Введите процент времени существования сертификата, который остается, прежде чем устройство запросит его возобновление. Например, если ввести значение 20, будет предпринята попытка продления сертификата, когда срок действия сертификата истечет на 80 %. Попытки продления продолжаются до тех пор, пока обновление не будет успешным. При обновлении создается новый сертификат, что приводит к созданию новой пары из открытого и закрытого ключей.

   - **URL-адреса серверов SCEP**.

     Введите один или несколько URL-адресов для серверов NDES, которые выдают сертификаты через SCEP. Например, можно ввести *https://ndes.contoso.com/certsrv/mscep/mscep.dll* . При необходимости можно добавить дополнительные URL-адреса SCEP для балансировки нагрузки, так как URL-адреса передаются на устройство с профилем случайным образом. Если один из серверов SCEP недоступен, запрос SCEP завершится ошибкой и при последующих регистрациях устройства запрос сертификата может быть сделан к тому же серверу, который не работает.

8. Нажмите кнопку **ОК**, а затем выберите **Создать**. Профиль создается и отображается в списке *Конфигурация устройства — профили*.

### <a name="avoid-certificate-signing-requests-with-escaped-special-characters"></a>Избегайте использования запросов на подпись сертификата со специальными экранируемыми символами

Существует известная ошибка, связанная с запросами на сертификаты SCEP и PKCS, когда имя субъекта содержит экранируемые символы. Имена субъектов, которые содержат один из специальных символов в виде экранированного символа, формируют запрос CSR с неправильным именем субъекта. Неправильное имя субъекта приводит к сбою проверки запроса SCEP Intune и отказу в выдаче сертификата.

Специальные символы:
- \+
- ,
- ;
- =

Если имя субъекта содержит один из этих символов, вы можете выполнить одно из следующих действий:

- заключить значение имени субъекта, содержащее специальный символ, в кавычки;  
- удалить специальный символ из значения имени субъекта.

**Например**, у вас есть имя субъекта, которое отображается как *Test user (TestCompany, LLC)* .  CSR с именем субъекта, которое содержит *запятую* между *TestCompany* и LLC, представляет собой проблему.  Проблему можно решить, заключив в кавычки все имя субъекта или удалив запятую между *TestCompany* и *LLC*:

- **Добавление кавычек**: *CN=* "Test User (TestCompany, LLC)",OU=UserAccounts,DC=corp,DC=contoso,DC=com*
- **Удаление запятой**: *CN=Test User (TestCompany LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com*

 При этом попытки экранировать запятую с помощью символа обратной косой черты будут приводить к ошибке в журналах CRP:
 
- **Экранированная запятая**: *CN=Test User (TestCompany\\, LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com*

Эта ошибка похожа на следующую ошибку:

```
Subject Name in CSR CN="Test User (TESTCOMPANY\, LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com" and challenge CN=Test User (TESTCOMPANY\, LLC),OU=UserAccounts,DC=corp,DC=contoso,DC=com do not match  

  Exception: System.ArgumentException: Subject Name in CSR and challenge do not match

   at Microsoft.ConfigurationManager.CertRegPoint.ChallengeValidation.ValidationPhase3(PKCSDecodedObject pkcsObj, CertEnrollChallenge challenge, String templateName, Int32 skipSANCheck)

Exception:    at Microsoft.ConfigurationManager.CertRegPoint.ChallengeValidation.ValidationPhase3(PKCSDecodedObject pkcsObj, CertEnrollChallenge challenge, String templateName, Int32 skipSANCheck)

   at Microsoft.ConfigurationManager.CertRegPoint.Controllers.CertificateController.VerifyRequest(VerifyChallengeParams value
```

## <a name="assign-the-certificate-profile"></a>Назначение профиля сертификата

Назначение профилей сертификатов SCEP аналогично [развертыванию профилей устройств](../configuration/device-profile-assign.md) для других целей. Однако перед продолжением примите во внимание следующее.

- При назначении профилей сертификатов группам на устройстве устанавливается файл доверенного корневого сертификата ЦС (указанный в *профиле доверенного сертификата*). Устройство использует профиль сертификата SCEP для создания запроса на сертификат для этого доверенного корневого сертификата ЦС.

- Профиль сертификата SCEP устанавливается только на устройствах с платформой, указанной при создании профиля сертификата.

- Можно назначать профили сертификатов и для коллекции пользователей, и для устройств.

- Чтобы опубликовать сертификат на устройстве сразу после регистрации, назначьте профиль сертификата в группе пользователей, а не в группе устройств. Если вы назначаете профиль группе устройств, требуется полная регистрация устройства для получения политик.

- Если вы используете совместное управление для Intune и Configuration Manager, в Configuration Manager установите [ползунок рабочей нагрузки](https://docs.microsoft.com/configmgr/comanage/how-to-switch-workloads) для параметра "Политики доступа к ресурсам" напротив значения **Intune** или **Пилотная версия Intune**. Этот параметр позволяет клиентам Windows 10 запускать процесс запроса сертификата.

- Хотя профиль доверенного сертификата и профиль сертификата SCEP создаются и назначаются отдельно, они оба должны быть назначены. При их отсутствии на устройстве политика сертификатов SCEP сообщает об ошибке. Убедитесь, что все профили доверенных корневых сертификатов также развернуты в тех же группах, что и профиль SCEP.

> [!NOTE]
> На устройствах iOS/iPadOS, если профиль сертификата SCEP связан с дополнительным профилем, например Wi-Fi или VPN, устройство получает сертификат для каждого из этих профилей. Из-за этого запрос на сертификат SCEP получает множество сертификатов на устройствах iOS/iPadOS.  Если требуется один сертификат, необходимо использовать сертификаты PKCS вместо сертификатов SCEP.  Это обусловлено различиями в способе доставки сертификатов SCEP и PKCS на устройства.

## <a name="next-steps"></a>Дальнейшие шаги

[Назначение профилей](../configuration/device-profile-assign.md)

[Overview for troubleshooting SCEP certificate profiles with Microsoft Intune](../protect/troubleshoot-scep-certificate-profiles.md) (Устранение неполадок при развертывании профилей сертификатов SCEP с помощью Microsoft Intune)