---
title: Использование импортированных сертификатов PFX в Microsoft Intune — Azure | Документация Майкрософт
description: Используйте импортированные сертификаты PKCS в службе Microsoft Intune, в которой можно импортировать сертификаты, настраивать шаблоны сертификатов, устанавливать соединитель сертификатов Intune для импортированных файлов PFX и создавать профили импортированных сертификатов PKCS.
keywords: ''
author: ralms
ms.author: brenduns
manager: dougeby
ms.date: 10/02/2019
ms.topic: article
ms.prod: ''
ms.service: microsoft-intune
ms.localizationpriority: high
ms.technology: ''
ms.assetid: ''
ms.reviewer: lacranda
ms.suite: ems
search.appverid: MET150
ms.custom: intune-azure; seodec18
ms.collection: M365-identity-device-management
ms.openlocfilehash: fead8b9d69f5356876c0b3a2a4ce02e9b754128e
ms.sourcegitcommit: 29b1113dc04534c4c87c33c773c5a0e24266e042
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/07/2019
ms.locfileid: "71999346"
---
# <a name="configure-and-use-imported-pkcs-certificates-with-intune"></a>Настройка и использование импортированных сертификатов PKCS в Intune

В Microsoft Intune можно использовать импортированные сертификаты с парой открытых ключей (PKCS), которые обычно используются для шифрования S/MIME с профилями электронной почты. Некоторые профили электронной почты в Intune позволяют включать S/MIME, чтобы определить сертификат подписи S/MIME и сертификат шифрования S/MIME.

Шифрование S/MIME — это сложная задача, так как электронная почта шифруется с помощью определенного сертификата. Необходимо иметь закрытый ключ сертификата, с помощью которого было зашифровано электронное письмо на целевом устройстве, чтобы это письмо можно было расшифровать. Сертификаты шифрования регулярно обновляются. Это означает, что вам может потребоваться журнал шифрования на всех устройствах для возможности чтения старых электронных сообщений.  Хотя один и тот же сертификат нужно использовать на разных устройствах, это нельзя делать с помощью профилей сертификатов [SCEP](certificates-scep-configure.md) или [PKCS](certficates-pfx-configure.md), так как соответствующие механизмы доставки сертификатов передают уникальный сертификат на каждое устройство. 

См. сведения об [использовании S/MIME с Intune](certificates-s-mime-encryption-sign.md).

## <a name="requirements"></a>Requirements (Требования)

Чтобы использовать импортированные сертификаты PKCS с Intune, необходима следующая инфраструктура:

- **Соединитель сертификатов PFX для Microsoft Intune**.  
  Каждый клиент Intune поддерживает один экземпляр этого соединителя. Можно установить этот соединитель на том же сервере, что и экземпляр Microsoft Intune Certificate Connector.

  Соединитель обрабатывает запросы на PFX-файлы, импортированные в Intune для шифрования электронной почты S/MIME для конкретного пользователя.  

  Этот соединитель автоматически обновляется при появлении новых версий. Чтобы использовать функцию обновления, убедитесь, что брандмауэры разрешают соединителю подключаться к **autoupdate.msappproxy.net** через порт **443**.  

  Дополнительные сведения обо всех сетевых конечных точках, к которым обращается соединитель, см. в статье [Требования к конфигурации сети Intune и ее пропускная способность](../fundamentals/network-bandwidth-use.md).


- **Windows Server**.  
  Используйте Windows Server для размещения соединителя сертификатов PFX для Microsoft Intune.  Соединитель используется для обработки запросов на получение сертификатов, импортированных в Intune.

  В Intune поддерживается установка *Microsoft Intune Certificate Connector* и *соединителя сертификатов PFX для Microsoft Intune* на одном сервере.

  Для работы соединителя на сервере требуется установить .NET Framework 4.6 или последующие версии. Если платформа .NET Framework 4.6 не установлена, при запуске установки соединителя она будет установлена автоматически.

- **Visual Studio 2015 или последующие версии** (необязательно): С помощью Visual Studio можно создать вспомогательный модуль PowerShell с командлетами для импорта сертификатов PFX в Microsoft Intune. Командлеты вспомогательного модуля PowerShell доступны в [этом репозитории GitHub](https://github.com/microsoft/Intune-Resource-Access/tree/develop/src/PFXImportPowershell).

## <a name="how-it-works"></a>Принцип работы

Когда вы используете Intune для развертывания **импортированного сертификата PFX** для пользователя, кроме самого устройства задействовано еще два компонента: 

- **Служба Intune**. В ней хранятся сертификаты PFX в зашифрованном состоянии и выполняется развертывание сертификата на устройстве пользователя.  Пароли, защищающие закрытые ключи сертификатов, шифруются перед их передачей с помощью аппаратного модуля безопасности (HSM) или шифрования Windows. Это гарантирует, что Intune не сможет получить доступ к закрытому ключу в любое время.
- **Соединитель сертификатов PFX для Microsoft Intune**. Когда устройство запрашивает сертификат PFX, импортированный в Intune, зашифрованный пароль, сертификат и открытый ключ устройства передаются в соединитель.  Соединитель расшифровывает пароль с помощью локального закрытого ключа, а затем повторно шифрует пароль (и все профили plist при использовании iOS) с помощью ключа устройства перед отправкой сертификата обратно в Intune.  Затем Intune доставляет сертификат на устройство, после чего устройство может расшифровать его с помощью закрытого ключа устройства и установить сертификат.

## <a name="download-install-and-configure-the-pfx-certificate-connector-for-microsoft-intune"></a>Скачивание, установка и настройка соединителя сертификатов PFX для Microsoft Intune

1. На портале [Intune](https://go.microsoft.com/fwlink/?linkid=2090973) выберите **Конфигурация устройства** > **Соединители сертификатов** > **Добавить**.

   ![Скачивание соединителя сертификатов PFX для Microsoft Intune](./media/certificates-imported-pfx-configure/download-imported-pfxconnector.png)

2. Следуйте указаниям по скачиванию *соединителя сертификатов PFX для Microsoft Intune* в расположение, доступное на сервере, на котором планируется установить соединитель.
3. По завершении скачивания войдите на сервер и запустите установщик (PfxCertificateConnectorBootstrapper.exe).  
   - Если установка выполняется в расположение по умолчанию, соединитель будет установлен в `Program Files\Microsoft Intune\PFXCertificateConnector`.
   - Служба соединителя выполняется под учетной записью локальной системы. Если прокси-серверу требуется доступ к Интернету, убедитесь, что учетная запись локальной службы может получить доступ к параметрам прокси-сервера на сервере.

4. Соединитель сертификата PFX для Microsoft Intune открывает вкладку **Регистрация** после установки. Чтобы включить подключение к Intune, щелкните **Войти** и укажите данные учетной записи Azure с разрешениями глобального администратора или администратора Intune.

   > [!WARNING]
   > По умолчанию в Windows Server **включена** **конфигурация усиленной безопасности Internet Explorer**, что может вызвать проблемы с входом в Office 365.

5. Закройте окно.
6. На портал Intune вернитесь в раздел **Конфигурация устройства** > **Соединители сертификатов**. Через несколько секунд отобразится зеленая галочка и параметру **Состояние подключения** будет присвоено значение **Активно**. Сервер соединителя теперь может взаимодействовать с Intune.

## <a name="import-pfx-certificates-to-intune"></a>Импорт сертификатов PFX в Intune

Для импорта в Intune пользовательских сертификатов PFX используется [Microsoft Graph](https://docs.microsoft.com/graph). Вспомогательный модуль, [доступный для скачивания в этом репозитории GitHub](https://github.com/microsoft/Intune-Resource-Access/tree/develop/src/PFXImportPowershell), предоставляет командлеты, упрощающие эту задачу.

Если вы предпочитаете использовать c Graph собственное пользовательское решение, используйте [тип ресурса userPFXCertificate](https://docs.microsoft.com/graph/api/resources/intune-raimportcerts-userpfxcertificate?view=graph-rest-beta).

### <a name="build-pfximport-powershell-project-cmdlets"></a>Сборка командлетов PFXImport PowerShell Project

Чтобы использовать командлеты PowerShell, вам нужно самостоятельно выполнить сборку проекта с помощью Visual Studio. Этот простой процесс можно запустить на сервере, но мы рекомендуем выполнять его на локальном компьютере.  

1. Перейдите в корневой каталог репозитория [Intune-Resource-Access](https://github.com/microsoft/Intune-Resource-Access) на сайте GitHub, а затем скачайте или клонируйте репозиторий с помощью Git на свой компьютер.

   ![Кнопка скачивания на сайте GitHub](./media/certificates-imported-pfx-configure/github-download.png)

2. Перейдите в `.\Intune-Resource-Access-develop\src\PFXImportPowershell\` и откройте проект с помощью Visual Studio, используя файл **PFXImportPS.sln**.
3. Вверху перейдите из режима **Отладка** в режим **Выпуск**.
4. Перейдите в меню **Сборка** и выберите **Собрать PFXImportPS**. Через несколько секунд в левом нижнем углу Visual Studio отобразится сообщение **Сборка успешно завершена**.

   ![Параметры сборки в Visual Studio](./media/certificates-imported-pfx-configure/vs-build-release.png)

5. В ходе сборки в `.\Intune-Resource-Access-develop\src\PFXImportPowershell\PFXImportPS\bin\Release` создается папка с модулем PowerShell.

   Эта папка **Release** будет использоваться на следующих шагах.

### <a name="create-the-encryption-public-key"></a>Создание открытого ключа шифрования

Сертификаты PFX и их закрытые ключи импортируются в Intune. Пароль, защищающий закрытый ключ, шифруется с помощью открытого ключа, хранящегося локально. Для создания и хранения пар открытого и закрытого ключей можно использовать шифрование Windows, аппаратный модуль безопасности или другой тип шифрования.  В зависимости от типа используемого шифрования пара открытого и закрытого ключей может быть экспортирована в виде файла для резервного копирования.

Модуль PowerShell предоставляет методы для создания ключа с помощью шифрования Windows. Для создания ключа также можно использовать другие средства.  

#### <a name="to-create-the-encryption-key-using-windows-cryptography"></a>Создание ключа шифрования с помощью шифрования Windows

1. Скопируйте созданную в Visual Studio папку *Release* на сервер, на котором установлен **соединитель сертификатов PFX для Microsoft Intune**. В этой папке находится модуль PowerShell.  
2. На сервере откройте *PowerShell* с правами администратора и перейдите в папку *Release*, содержащую модуль PowerShell.
3. Чтобы импортировать модуль, выполните команду `Import-Module .\IntunePfxImport.psd1`.
4. Затем выполните команду `Add-IntuneKspKey "Microsoft Software Key Storage Provider" "PFXEncryptionKey"`.

   > [!TIP]  
   > Используемый поставщик необходимо выбрать еще раз при импорте сертификатов PFX. Вы можете использовать поставщик хранилища ключей **Microsoft Software Key Storage Provider** или другой поставщик. Ключу можно задать произвольное имя.  

   Если вы планируете импортировать сертификат с компьютера, этот ключ можно экспортировать в файл с помощью команды `Export-IntunePublicKey -ProviderName "<ProviderName>" -KeyName "<KeyName>" -FilePath "<File path to write to>"`.

   Закрытый ключ нужно импортировать на сервер, на котором размещается соединитель сертификатов PFX для Microsoft Intune, для обработки импортированных сертификатов PFX.  

#### <a name="to-use-a-hardware-security-module-hsm"></a>Создание ключа шифрования с помощью аппаратного модуля безопасности (HSM)  

Для создания и хранения пары открытого и закрытого ключей можно использовать аппаратный модуль безопасности (HSM). Дополнительные сведения см. в документации поставщика HSM.

### <a name="import-pfx-certificates"></a>Импорт сертификатов PFX 

В следующем примере сертификаты PFX импортируются с помощью командлетов PowerShell. Выбор параметров определяется вашими задачами.

Возможны следующие значения.  
- Предполагаемое назначение (группирование сертификатов по тегам):  
  - unassigned
  - smimeEncryption
  - smimeSigning


- Схема заполнения:  
  - pkcs1
  - oaepSha1
  - oaepSha256
  - oaepSha384
  - oaepSha512

Выберите поставщик хранилища ключей, соответствующий поставщику, используемому для создания ключа.

#### <a name="to-import-the-pfx-certificate"></a>Импорт сертификата PFX  

1. Экспортируйте сертификаты из любого центра сертификации (ЦС), следуя инструкциям из документации поставщика.  Для служб сертификации Microsoft Active Directory можно использовать [этот пример скрипта](https://gallery.technet.microsoft.com/Export-CMPfxCertificatesFro-d55f687b).   
2. На сервере откройте *PowerShell* с правами администратора и перейдите в папку *Release*, содержащую модуль PowerShell.
3. Чтобы импортировать модуль, выполните команду `Import-Module .\IntunePfxImport.psd1`.  
4. Чтобы выполнить аутентификацию для входа в Intune Graph, выполните команду `$authResult = Get-IntuneAuthenticationToken -AdminUserName "<Admin-UPN>"`.

   > [!NOTE]
   > При выполнении аутентификации для входа в Graph необходимо предоставить разрешения для AppID. Если вы впервые используете эту служебную программу, вам понадобятся права *глобального администратора*. Командлеты PowerShell используют тот же идентификатор AppID, что и в [примерах PowerShell для Intune](https://github.com/microsoftgraph/powershell-intune-samples).   
5. Преобразуйте пароль для каждого импортируемого файла PFX в защищенную строку, выполнив команду `$SecureFilePassword = ConvertTo-SecureString -String "<PFXPassword>" -AsPlainText -Force`.  
6. Чтобы создать объект **UserPFXCertificate**, выполните команду `$userPFXObject = New-IntuneUserPfxCertificate -PathToPfxFile "<FullPathPFXToCert>" $SecureFilePassword "<UserUPN>" "<ProviderName>" "<KeyName>" "<IntendedPurpose>" "<PaddingScheme>"`.

   Пример: `$userPFXObject = New-IntuneUserPfxCertificate -PathToPfxFile "C:\temp\userA.pfx" $SecureFilePassword "userA@contoso.com" "Microsoft Software Key Storage Provider" "PFXEncryptionKey" "smimeEncryption" "pkcs1"`

   > [!NOTE]  
   > При импорте сертификата из другой системы (не сервера, на котором установлен соединитель), выполните следующую команду, которая добавляет путь к файлу ключа: `$userPFXObject = New-IntuneUserPfxCertificate -PathToPfxFile "<FullPathPFXToCert>" $SecureFilePassword "<UserUPN>" "<ProviderName>" "<KeyName>" "<IntendedPurpose>" "<PaddingScheme>" "<File path to public key file>"`.

7. Импортируйте объект **UserPFXCertificate** в Intune, выполнив команду `Import-IntuneUserPfxCertificate -AuthenticationResult $authResult -CertificateList $userPFXObject`.

8. Чтобы проверить, был ли сертификат импортирован, выполните команду `Get-IntuneUserPfxCertificate -AuthenticationResult $authResult -UserList "<UserUPN>"`.

Сведения о других доступных командах см. файле сведений в [этом репозитории на сайте GitHub](https://github.com/microsoft/Intune-Resource-Access/tree/develop/src/PFXImportPowershell).

## <a name="create-a-pkcs-imported-certificate-profile"></a>Создание профиля импортированного сертификата PKCS

После импорта сертификатов в Intune создайте профиль **импортированного сертификата PKCS** и назначьте его группам Azure Active Directory.

1. На портале [Intune](https://go.microsoft.com/fwlink/?linkid=2090973) перейдите в меню **Конфигурация устройства** > **Профили** > **Создать профиль**.
2. Укажите следующие свойства.

   - **Имя** для профиля.
   - При необходимости задайте описание.
   - **Платформа**, на которой нужно развернуть профиль.
   - Задайте **импортированный сертификат PKCS** в качестве **типа профиля**.

3. Откройте **Параметры** и укажите следующие свойства:

   - **Предполагаемое назначение**. Укажите предполагаемое назначение сертификатов, импортированных для этого профиля. Администраторы могут импортировать сертификаты с разными назначениями (например, для подписывания или шифрования S/MIME). Предполагаемое назначение, выбранное в профиле сертификата, соответствует профилю сертификата с соответствующими импортированными сертификатами. Предполагаемое назначение обозначается тегом для группирования импортированных сертификатов. При этом нет гарантии, что импортированные сертификаты с определенным тегом будут соответствовать предполагаемому назначению.  
   - **Срок действия сертификата**. Если в шаблоне сертификата не был изменен срок действия, по умолчанию он составляет один год.  
   - **Поставщик хранилища ключей (KSP)** . Для Windows выберите место для хранения ключей на устройстве.  

4. Выберите **ОК** > **Создать**, чтобы сохранить профиль.
5. Чтобы назначить новый профиль для одного или нескольких устройств, см. статью [Назначение профилей устройств Microsoft Intune](../configuration/device-profile-assign.md).



