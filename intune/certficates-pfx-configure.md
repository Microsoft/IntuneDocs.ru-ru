---
title: Использование сертификатов PKCS с Microsoft Intune — Azure | Документы Майкрософт
description: Добавьте или создайте сертификаты стандартов шифрования с открытым ключом с помощью Microsoft Intune, в том числе экспортируйте корневой сертификат, настройте шаблон сертификата, скачайте и установите Microsoft Intune Certificate Connector (NDES), создайте профиль конфигурации устройства, создайте профиль сертификата PKCS в Azure и ЦС.
keywords: ''
author: MandiOhlinger
ms.author: mandia
manager: dougeby
ms.date: 08/21/2018
ms.topic: article
ms.prod: ''
ms.service: microsoft-intune
ms.technology: ''
ms.assetid: ''
ms.reviewer: ''
ms.suite: ems
ms.custom: intune-azure
ms.openlocfilehash: a86b53e34cc4fa24ec683657a646f8545396166e
ms.sourcegitcommit: 488be75cbee88455b33c68a3ec2acb864d461bf8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/22/2018
ms.locfileid: "41910842"
---
# <a name="configure-and-use-pkcs-certificates-with-intune"></a>Настройка и использование сертификатов PKCS в Intune

> [!IMPORTANT]
> Мы вносим некоторые улучшения в функцию S/MIME, описанную в этой статье. Поэтому функция S/MIME временно удалена из Intune. Когда функция будет выпущена, мы удалим это примечание.

Сертификаты используются для проверки подлинности и защищенного доступа к ресурсам организации, например виртуальной частной сети или сети Wi-Fi. В этой статье показано, как экспортировать сертификат PKCS, а затем добавить его в профиль Intune.

## <a name="requirements"></a>Requirements (Требования)

Чтобы использовать сертификаты PKCS с Intune, необходима следующая инфраструктура:

- **Домен Active Directory**: все серверы, указанные в этом разделе, должны быть присоединены к домену Active Directory.

  Дополнительные сведения об установке и настройке AD DS см. в статье [Планирование и проектирование доменных служб Active Directory](https://docs.microsoft.com/windows-server/identity/ad-ds/plan/ad-ds-design-and-planning).

- **Центр сертификации** (ЦС): центр сертификации (ЦС) предприятия.

  Дополнительные сведения об установке и настройке служб сертификатов Active Directory (AD CS) см. в статье [Пошаговое руководство по службам сертификатов Active Directory](https://technet.microsoft.com/library/cc772393).

  > [!WARNING]
  > Intune требуется запустить службу сертификации Active Directory с помощью центра сертификации предприятия (ЦС), а не автономного ЦС.

- **Клиент**: для подключения к ЦС предприятия.

- **Корневой сертификат**: экспортированная копия корневого сертификата из ЦС предприятия.

- **Microsoft Intune Certificate Connector**: используйте портал Azure, чтобы скачать установщик **соединителя сертификатов** (**NDESConnectorSetup.exe**). 

  Соединитель обрабатывает запросы сертификатов PKCS, используемые для проверки подлинности или подписывания электронной почты S/MIME.

  Соединитель сертификатов NDES также поддерживает режим федерального стандарта обработки информации (FIPS). Режим FIPS не является обязательным, но когда он включен, вы можете выдавать и отменять сертификаты.

- **Соединитель сертификата PFX для Microsoft Intune**. Если вы планируете использовать шифрование электронной почты S/MIME, загрузите установщик **соединителя сертификатов PFX для Microsoft Intune** (**PfxCertificateConnectorBootstrapper.exe**) на портале Azure. Соединитель обрабатывает запросы на PFX-файлы, импортированные в Intune для шифрования электронной почты S/MIME для конкретного пользователя.

- **Windows Server**. На сервере размещаются:

  - соединитель сертификатов Microsoft Intune (NDESConnectorSetup.exe) для проверки подлинности и сценариев подписывания электронной почты S/MIME;
  - соединитель сертификатов PFX для Microsoft Intune (PfxCertificateConnectorBootstrapper.exe) для сценариев шифрования электронной почты S/MIME.

  Можно запустить сразу оба соединителя (**соединитель сертификатов Microsoft Intune** и **соединитель сертификатов PFX для Microsoft Intune**) на одном сервере.

## <a name="export-the-root-certificate-from-the-enterprise-ca"></a>Экспортирование корневого сертификата из ЦС предприятия

Для выполнения проверки подлинности с помощью VPN, Wi-Fi или других ресурсов необходим корневой сертификат или сертификат промежуточного ЦС на каждом устройстве. Далее описывается, как получить необходимый сертификат из ЦС предприятия.

1. Войдите в ЦС предприятия с использованием учетной записи с правами администратора.
2. Откройте командную строку как администратор.
3. Экспортируйте сертификат корневого ЦС (.cer) туда, где вы сможете открыть его позже.
4. После завершения работы мастера, но перед тем, как закрыть его, щелкните **Запустить пользовательский интерфейс соединителя сертификатов**.

   `certutil -ca.cert certnew.cer`

   Дополнительные сведения см. в разделе [Задачи Certutil для управления сертификатами](https://technet.microsoft.com/library/cc772898.aspx#BKMK_ret_sign).

## <a name="configure-certificate-templates-on-the-certification-authority"></a>Настройка шаблонов сертификатов в центре сертификации

1. Войдите в ЦС предприятия с использованием учетной записи с правами администратора.
2. Откройте консоль **ЦС**, щелкните правой кнопкой мыши **Шаблоны сертификатов** и выберите **Управление**.
3. Найдите шаблон сертификата **пользователя**, щелкните его правой кнопкой мыши и выберите **Скопировать шаблон**. Откроется страница **Свойства нового шаблона**.

    > [!NOTE]
    > Для сценариев подписывания и шифрования электронной почты S/MIME многие администраторы используют отдельные сертификаты для подписывания и шифрования. Если вы используете службы сертификатов Microsoft Active Directory, можно использовать шаблон сертификатов для подписывания электронной почты S/MIME **Только подпись Exchange** и шаблон сертификатов для шифрования электронной почты S/MIME **Пользователь Exchange**.  Если вы используете сторонний центр сертификации, рекомендуется изучить соответствующее руководство по созданию шаблонов подписывания и шифрования.

4. На вкладке **Совместимость**:

  - Задайте для **центра сертификации** значение **Windows Server 2008 R2**.
  - Задайте для **получателя сертификации** значение **Windows 7 / Server 2008 R2**.

5. На вкладке **Общие** задайте осмысленное **отображаемое имя шаблона**.

    > [!WARNING]
    > **Имя шаблона** по умолчанию совпадает с **отображаемым именем шаблона** *без пробелов*. Запомните имя шаблона, оно вам еще понадобится.

6. На вкладке **Обработка запроса** выберите **Разрешить экспорт закрытого ключа**.
7. На вкладке **Шифрование** убедитесь, что **Минимальный размер ключа** равен 2048.
8. На вкладке **Имя субъекта** выберите **Предоставлять по запросу**.
9. На вкладке **Расширения** подтвердите, что шифрованная файловая система, защита электронной почты и проверка подлинности клиента отображаются в разделе **Политики приложений**.

    > [!IMPORTANT]
    > Для шаблонов сертификатов iOS на вкладке **Расширения** обновите параметр **Использование ключей** и снимите флажок **Signature is proof of origin** (Подпись подтверждает подлинность).

10. На вкладке **Безопасность** добавьте учетную запись компьютера для сервера, на котором устанавливается Microsoft Intune Certificate Connector. Назначьте для этой учетной записи разрешения на **чтение** и **регистрацию**.
11. Щелкните **Применить**, а затем **ОК**, чтобы сохранить шаблон сертификата.
12. Закройте **Консоль шаблонов сертификатов**.
13. Из консоли **центра сертификации** щелкните правой кнопкой мыши **Шаблоны сертификатов**, **New** (Создать), **Certificate Template to Issue** (Выдаваемый шаблон сертификата). Выберите шаблон, созданный на предыдущем шаге, и нажмите кнопку **ОК**.
14. Чтобы сервер мог управлять сертификатами от имени зарегистрированных устройств и пользователей Intune, сделайте следующее:

    1. Щелкните центр сертификации правой кнопкой мыши и выберите **Свойства**.
    2. На вкладке "Безопасность" добавьте учетную запись компьютера для сервера, на котором запущены соединитель (**соединитель сертификатов Microsoft Intune** или **соединитель сертификатов PFX для Microsoft Intune**). Предоставьте для параметров **Issue and Manage Certificates** (Выдача сертификатов и управление ими) и **Request Certificates** (Запросить сертификаты) разрешения на доступ к учетной записи компьютера.

15. Выйдите из ЦС предприятия.

## <a name="download-install-and-configure-the-certificate-connectors"></a>Скачивание, установка и настройка соединителя сертификатов

### <a name="microsoft-intune-certificate-connector"></a>Соединитель сертификатов Microsoft Intune

![ConnectorDownload][ConnectorDownload]

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Все службы**, отфильтруйте список по **Intune** и выберите **Microsoft Intune**.
3. Выберите **Конфигурация устройства**, а затем — **Центр сертификации**.
4. Выберите **Добавить** и загрузите соединитель сертификатов Microsoft Intune. Сохраните файл в расположении, в котором вы сможете открыть его с сервера, на котором выполняется установка.
5. После завершения скачивания войдите на сервер. Затем сделайте следующее:

    1. Убедитесь, что установлена среда .NET 4.5 Framework (или более поздней версии), так как она необходима для соединителя сертификатов NDES. .NET 4.5 Framework автоматически входит в состав Windows Server 2012 R2 и более новых версий.
    2. Запустите установщик (NDESConnectorSetup.exe) и примите расположение по умолчанию. Соединитель устанавливается в папке `\Program Files\Microsoft Intune\NDESConnectorUI`. В параметрах установщика выберите **Распределение PFX**. Продолжите процедуру и завершите установку.
    3. По умолчанию служба соединителя выполняется под учетной записью локальной системы. Если прокси-серверу требуется доступ к Интернету, убедитесь, что учетная запись локальной службы может получить доступ к параметрам прокси-сервера на сервере.

6. Открывается вкладка **Регистрация** окна "Соединитель NDES". Чтобы включить подключение к Intune, щелкните **Войти** и укажите данные учетной записи с глобальными административными разрешениями.
7. На вкладке **Дополнительно** должен быть выбран пункт **Использовать СИСТЕМНУЮ учетную запись этого компьютера (по умолчанию)**.
8. Нажмите **Применить**, а затем **Закрыть**.
9. Вернитесь на портал Azure (**Intune** > **Конфигурация устройства** > **ЦС**). Через несколько секунд отображается зеленая галочка, и **Состояние подключения** станет **Активно**. Сервер соединителя теперь может взаимодействовать с Intune.

> [!NOTE]
> Поддержка TLS 1.2 входит в состав соединителя сертификатов Microsoft Intune. Если сервер с установленным соединителем сертификатов Microsoft Intune поддерживает TLS 1.2, то используется TLS 1.2. Если сервер не поддерживает TLS 1.2, то используется TLS 1.1. Сейчас TLS 1.1 используется для проверки подлинности между устройствами и сервером.

### <a name="pfx-certificate-connector-for-microsoft-intune"></a>Соединитель сертификатов PFX для Microsoft Intune

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Все службы**, отфильтруйте список по **Intune** и выберите **Microsoft Intune**.
3. Выберите **Конфигурация устройства**, а затем — **Центр сертификации**.
4. Выберите **Добавить** и загрузите соединитель сертификатов PFX для Microsoft Intune. Сохраните файл в расположении, в котором вы сможете открыть его с сервера, на котором выполняется установка.
5. После завершения скачивания войдите на сервер. Затем сделайте следующее:

    1. Убедитесь, что установлена среда .NET 4.6 Framework (или более поздней версии), так как она необходима для соединителя сертификатов PFX для Microsoft Intune. Если .NET 4.6 Framework не установлена, установщик устанавливает его автоматически.
    2. Запустите установщик (PfxCertificateConnectorBootstrapper.exe) и примите расположение по умолчанию. Соединитель устанавливается в папке `Program Files\Microsoft Intune\PFXCertificateConnector`.
    3. Служба соединителя выполняется под учетной записью локальной системы. Если прокси-серверу требуется доступ к Интернету, убедитесь, что учетная запись локальной службы может получить доступ к параметрам прокси-сервера на сервере.

6. Соединитель сертификата PFX для Microsoft Intune открывает вкладку **Регистрация** после установки. Чтобы включить подключение к Intune, щелкните **Войти** и укажите данные учетной записи Azure с разрешениями глобального администратора или администратора Intune.
7. Закройте окно.
8. Вернитесь на портал Azure (**Intune** > **Конфигурация устройства** > **ЦС**). Через несколько секунд отображается зеленая галочка, и **Состояние подключения** станет **Активно**. Сервер соединителя теперь может взаимодействовать с Intune.

## <a name="create-a-trusted-certificate-profile"></a>Создание профиля доверенного сертификата

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Intune** > **Конфигурация устройства** > **Профили** > **Создать профиль**.

   ![NavigateIntune][NavigateIntune]

3. Укажите следующие свойства.

    - **Имя** для профиля.
    - При необходимости задайте описание.
    - **Платформа**, на которой нужно развернуть профиль.
    - Задайте **доверенный сертификат** в качестве **типа профиля**.

4. Перейдите к **параметрам** и укажите CER-файл ранее экспортированного сертификата корневого ЦС.

   > [!NOTE]
   > В зависимости от платформы, выбранной на **шаге 3**, вы можете (или не можете) выбрать **конечное хранилище** для сертификата.

   ![ProfileSettings][ProfileSettings]

5. Щелкните **ОК**, а затем **Создать**, чтобы сохранить профиль.
6. Чтобы назначить новый профиль для одного или нескольких устройств, см. статью [Назначение профилей устройств Microsoft Intune](device-profile-assign.md).

## <a name="create-a-pkcs-certificate-profile"></a>Создание профиля сертификата PKCS

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Intune** > **Конфигурация устройства** > **Профили** > **Создать профиль**.
3. Укажите следующие свойства.

    - **Имя** для профиля.
    - При необходимости задайте описание.
    - **Платформа**, на которой нужно развернуть профиль.
    - Задайте **сертификат PKCS** в качестве **типа профиля**.

4. Откройте **Параметры** и укажите следующие свойства:

    - **Renewal threshold (%)** (Порог обновления (%)) — рекомендовано 20 %.
    - **Срок действия сертификата** — если вы не изменяли шаблон сертификата, для этого параметра следует задать один год.
    - **Поставщик хранилища ключей (KSP)** — для Windows выберите место для хранения ключей на устройстве.
    - **Центр сертификации** — отображает внутреннее полное доменное имя (FQDN) ЦС предприятия.
    - **Имя центра сертификации** — отображает имя ЦС предприятия, например "Contoso Certification Authority".
    - **Имя шаблона сертификата** — имя шаблона, созданного ранее. Помните, что **имя шаблона** по умолчанию совпадает с **отображаемым именем шаблона** *без пробелов*.
    - **Формат имени субъекта** — задайте для этого параметра значение **Common name** (Обычное имя) (если не требуется иное).
    - **Subject alternative name** (Альтернативное имя субъекта) — в качестве значения этого параметра нужно задать **Имя участника-пользователя (UPN)** (если не требуется иное).

5. Щелкните **ОК**, а затем **Создать**, чтобы сохранить профиль.
6. Чтобы назначить новый профиль для одного или нескольких устройств, см. статью [Назначение профилей устройств Microsoft Intune](device-profile-assign.md).

## <a name="create-a-pkcs-imported-certificate-profile"></a>Создание профиля импортированного сертификата PKCS

Вы можете импортировать сертификаты, выданные ранее для конкретного пользователя, из любого центра сертификации Intune. Импортированные сертификаты устанавливаются на каждом устройстве, которое регистрирует пользователь. Шифрование электронной почты S/MIME является наиболее распространенным сценарием для импорта существующих PFX-сертификатов в Intune. Пользователь может иметь несколько сертификатов для шифрования электронной почты. Закрытые ключи каждого из этих сертификатов должны существовать на всех устройствах пользователя, чтобы они могли расшифровать ранее зашифрованные электронные письма.

Чтобы импортировать сертификаты в Intune, используйте [командлеты PowerShell в GitHub](https://github.com/Microsoft/Intune-Resource-Access).

После импорта сертификатов в Intune создайте профиль **импортированного сертификата PKCS** и назначьте его группам Azure Active Directory.

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Intune** > **Конфигурация устройства** > **Профили** > **Создать профиль**.
3. Укажите следующие свойства.

    - **Имя** для профиля.
    - При необходимости задайте описание.
    - **Платформа**, на которой нужно развернуть профиль.
    - Задайте **импортированный сертификат PKCS** в качестве **типа профиля**.

4. Откройте **Параметры** и укажите следующие свойства:

    - **Предполагаемое назначение** — предполагаемое назначение сертификатов, импортированных для этого профиля. Администратор может импортировать сертификаты с разными назначениями (например, для проверки подлинности, подписывания или шифрования S/MIME). Предполагаемое назначение, выбранное в профиле сертификата, соответствует профилю сертификата с соответствующими импортированными сертификатами.
    - **Срок действия сертификата** — если вы не изменяли шаблон сертификата, для этого параметра следует задать один год.
    - **Поставщик хранилища ключей (KSP)** — для Windows выберите место для хранения ключей на устройстве.

5. Щелкните **ОК**, а затем **Создать**, чтобы сохранить профиль.
6. Чтобы назначить новый профиль для одного или нескольких устройств, см. статью [Назначение профилей устройств Microsoft Intune](device-profile-assign.md).

## <a name="next-steps"></a>Дальнейшие шаги
[Используйте сертификаты SCEP](certificates-scep-configure.md) или [выдайте сертификаты PKCS из веб-службы диспетчера PKI Symantec](certificates-symantec-configure.md).

[NavigateIntune]: ./media/certificates-pfx-configure-profile-new.png "Перейдите к Intune на портале Azure и создайте профиль для доверенного сертификата"
[ProfileSettings]: ./media/certificates-pfx-configure-profile-fill.png "Создайте профиль и отправьте доверенный сертификат"
[ConnectorDownload]: ./media/certificates-download-connector.png "Скачайте соединитель сертификатов на портале Azure"  
