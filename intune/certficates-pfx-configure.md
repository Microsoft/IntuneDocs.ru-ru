---
title: Использование частных и общедоступных ключей сертификатов в Microsoft Intune — Azure | Документация Майкрософт
description: Добавьте или создайте сертификаты стандартов шифрования с открытым ключом (PKCS) с помощью Microsoft Intune, в том числе экспортируйте корневой сертификат, настройте шаблон сертификата, скачайте и установите Intune Certificate Connector (NDES), создайте профиль конфигурации устройства, а также профиль сертификата PKCS в Azure и ЦС.
keywords: ''
author: brenduns
ms.author: brenduns
manager: dougeby
ms.date: 08/26/2019
ms.topic: conceptual
ms.service: microsoft-intune
ms.localizationpriority: high
ms.technology: ''
ms.assetid: ''
ms.reviewer: lacranda
ms.suite: ems
search.appverid: MET150
ms.custom: intune-azure; seodec18
ms.collection: M365-identity-device-management
ms.openlocfilehash: 064377ea05319242da087862b4d2b3a721b0caef
ms.sourcegitcommit: 3db8af810b95c3a6ed3f8cc00f6ce79076ebb9db
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "71012467"
---
# <a name="configure-and-use-pkcs-certificates-with-intune"></a>Настройка и использование сертификатов PKCS в Intune

Intune поддерживает использование сертификатов частной и общедоступной пары ключей (PKCS). В этой статье вы узнаете, как настроить необходимую инфраструктуру, например локальные соединители сертификата, экспортировать сертификат PKCS и добавить сертификат в профиль конфигурации устройства Intune.

Microsoft Intune включает встроенные параметры, позволяющие использовать сертификаты PKCS для доступа и проверки подлинности к ресурсам организации. Сертификаты используются для проверки подлинности и защищенного доступа к ресурсам организации, например виртуальной частной сети или сети Wi-Fi. Вы разворачиваете эти параметры на устройствах, используя профили конфигурации устройств в Intune.

См. сведения об [использовании импортированных сертификатов PKCS](certificates-imported-pfx-configure.md).


## <a name="requirements"></a>Requirements (Требования)

Чтобы использовать сертификаты PKCS с Intune, необходима следующая инфраструктура:

- **Домен Active Directory**.  
  Все серверы, указанные в этом разделе, должны быть присоединены к домену Active Directory.

  Дополнительные сведения об установке и настройке доменных служб Active Directory см. в статье [Планирование и проектирование доменных служб Active Directory](https://docs.microsoft.com/windows-server/identity/ad-ds/plan/ad-ds-design-and-planning).

- **Центр сертификации**:  
   Центр сертификации предприятия.

  Дополнительные сведения об установке и настройке служб сертификатов Active Directory (AD CS) см. в статье [Пошаговое руководство по службам сертификатов Active Directory](https://technet.microsoft.com/library/cc772393).

  > [!WARNING]  
  > Intune требуется запустить службу сертификации Active Directory с помощью центра сертификации предприятия (ЦС), а не автономного ЦС.

- **Клиент**.  
  Для подключения к ЦС предприятия.

- **Корневой сертификат**.  
  Экспортированная копия корневого сертификата из ЦС предприятия.

- **Microsoft Intune Certificate Connector** (также называется *соединителем сертификатов NDES*).  
  На портале Intune перейдите в раздел **Конфигурация устройства** > **Соединители сертификатов** > **Добавить** и выполните *процедуру установки соединителя для PKCS № 12*. Используйте ссылку на портале, чтобы начать загрузку установщика соединителя сертификатов **NDESConnectorSetup.exe**.  

  Intune поддерживает до 100 экземпляров такого соединителя для каждого клиента, при этом каждый экземпляр находится на отдельном сервере Windows. Можно установить экземпляр этого соединителя на том же сервере, что и экземпляр соединителя сертификатов PFX для Microsoft Intune. При использовании нескольких соединителей их инфраструктура поддерживает высокий уровень доступности и балансировку нагрузки, так как любой доступный экземпляр соединителя может обрабатывать запросы на сертификаты PKCS. 

  Соединитель обрабатывает запросы сертификатов PKCS, используемые для проверки подлинности или подписывания электронной почты S/MIME.

  Microsoft Intune Certificate Connector также поддерживает режим федерального стандарта обработки информации (FIPS). Режим FIPS не является обязательным, но когда он включен, вы можете выдавать и отменять сертификаты.

- **Соединитель сертификатов PFX для Microsoft Intune**.  
  Если вы планируете использовать шифрование электронной почты S/MIME, на портале Intune скачайте *PFX Certificate Connector*.  Перейдите в раздел **Конфигурация устройства** > **Соединители сертификатов** > **Добавить** и выполните *процедуру установки соединителя для импортированных PFX-сертификатов*. Используйте ссылку на портале, чтобы начать загрузку установщика **PfxCertificateConnectorBootstrapper.exe**. 

  Каждый клиент Intune поддерживает один экземпляр этого соединителя. Можно установить этот соединитель на том же сервере, что и экземпляр Microsoft Intune Certificate Connector.

  Соединитель обрабатывает запросы на PFX-файлы, импортированные в Intune для шифрования электронной почты S/MIME для конкретного пользователя.  

  Этот соединитель автоматически обновляется при появлении новых версий. Чтобы использовать функцию обновления, необходимо:
  - Установить PFX Certificate Connector для Microsoft Intune на сервере.  
  - Чтобы автоматически получать важные обновления, убедитесь, что брандмауэры разрешают соединителю подключаться к **autoupdate.msappproxy.net** через порт **443**.   

  См. сведения обо всех сетевых конечных точках, к которым должен иметь доступ соединитель в описании [конечных точек сети для Microsoft Intune](intune-endpoints.md).

- **Windows Server**.  
  Windows Server используется для размещения следующих соединителей:

  - Microsoft Intune Certificate Connector для проверки подлинности и сценариев подписывания электронной почты S/MIME;
  - соединитель сертификатов PFX для Microsoft Intune для сценариев шифрования электронной почты S/MIME.

  В Intune поддерживается установка *PFX Certificate Connector* на том же сервере, где установлен *Microsoft Intune Certificate Connector*.
  
## <a name="export-the-root-certificate-from-the-enterprise-ca"></a>Экспортирование корневого сертификата из ЦС предприятия

Для выполнения проверки подлинности с помощью VPN, Wi-Fi или других ресурсов необходим корневой или промежуточный сертификат ЦС на каждом устройстве. Далее описывается, как получить необходимый сертификат из ЦС предприятия.

**Работа с командной строкой**.  
1. Войдите на сервер центра корневой сертификации с учетной записью администратора.
 
2. Выберите **Запуск** > **Выполнить** и введите **Cmd**, чтобы открыть командную строку. 
    
3. Укажите **certutil -ca.cert ca_name.cer**, чтобы экспортировать корневой сертификат в виде файла с именем *ca_name.cer*.



## <a name="configure-certificate-templates-on-the-ca"></a>Настройка шаблонов сертификатов в ЦС

1. Войдите в ЦС предприятия с использованием учетной записи с правами администратора.
2. Откройте консоль **ЦС**, щелкните правой кнопкой мыши **Шаблоны сертификатов** и выберите **Управление**.
3. Найдите шаблон сертификата **Пользователь**, щелкните его правой кнопкой мыши и выберите **Повторяющийся шаблон**. Откроется страница **Свойства нового шаблона**.

    > [!NOTE]
    > Для сценариев подписывания и шифрования электронной почты S/MIME многие администраторы используют отдельные сертификаты для подписывания и шифрования. Если вы используете службы сертификатов Microsoft Active Directory, можно использовать шаблон сертификатов для подписывания электронной почты S/MIME **Только подпись Exchange** и шаблон сертификатов для шифрования электронной почты S/MIME **Пользователь Exchange**.  Если вы используете сторонний центр сертификации, рекомендуется изучить соответствующее руководство по созданию шаблонов подписывания и шифрования.

4. На вкладке **Совместимость**:

    - Задайте для **центра сертификации** значение **Windows Server 2008 R2**.
    - Задайте для **получателя сертификации** значение **Windows 7 / Server 2008 R2**.

5. На вкладке **Общие** задайте осмысленное **отображаемое имя шаблона**.

    > [!WARNING]
    > **Имя шаблона** по умолчанию совпадает с **отображаемым именем шаблона** *без пробелов*. Запомните имя шаблона, оно вам еще понадобится.

6. На вкладке **Обработка запроса** выберите **Разрешить экспорт закрытого ключа**.
7. На вкладке **Шифрование** убедитесь, что **Минимальный размер ключа** равен 2048.
8. На вкладке **Имя субъекта** выберите **Предоставлять по запросу**.
9. На вкладке **Расширения** подтвердите, что шифрованная файловая система, защита электронной почты и проверка подлинности клиента отображаются в разделе **Политики приложений**.

    > [!IMPORTANT]
    > Для шаблонов сертификатов iOS на вкладке **Расширения** обновите параметр **Использование ключей** и снимите флажок **Signature is proof of origin** (Подпись подтверждает подлинность).

10. На вкладке **Безопасность** добавьте учетную запись компьютера для сервера, на котором устанавливается Microsoft Intune Certificate Connector. Назначьте для этой учетной записи разрешения на **чтение** и **регистрацию**.
11. Выберите **Применить** > **ОК**, чтобы сохранить шаблон сертификата. Закройте **Консоль шаблонов сертификатов**.
12. В консоли **Центр сертификации** щелкните правой кнопкой мыши **Шаблоны сертификатов** > **Создать** > **Выдаваемый шаблон сертификата**. Выберите созданный ранее шаблон. Нажмите кнопку **ОК**.
13. Чтобы сервер мог управлять сертификатами зарегистрированных устройств и пользователей, сделайте следующее:

    1. Щелкните центр сертификации правой кнопкой мыши и выберите **Свойства**.
    2. На вкладке "Безопасность" добавьте учетную запись компьютера для сервера, на котором запущены соединитель (**соединитель сертификатов Microsoft Intune** или **соединитель сертификатов PFX для Microsoft Intune**). 
    3. Предоставьте для параметров **Issue and Manage Certificates** (Выдача сертификатов и управление ими) и **Request Certificates** (Запросить сертификаты) разрешения на доступ к учетной записи компьютера.

14. Выйдите из ЦС предприятия.

## <a name="download-install-and-configure-the-microsoft-intune-certificate-connector"></a>Скачивание, установка и настройка Microsoft Intune Certificate Connector

> [!IMPORTANT]  
> Microsoft Intune Certificate Connector невозможно установить на действующий центр сертификации (ЦС). Его необходимо установить на отдельном сервере Windows.  

1. Войдите в [Intune](https://go.microsoft.com/fwlink/?linkid=2090973).
2. Выберите **Конфигурация устройства** > **Соединители сертификации** > **Добавить**.
3. Загрузите и сохраните файл соединителя в расположении, в котором вы сможете открыть его с сервера, где вы устанавливаете соединитель.

    ![Скачивание Microsoft Intune Certificate Connector](media/certificates-pfx-configure/download-ndes-connector.png)
 

4. После завершения скачивания войдите на сервер. Затем сделайте следующее:

    1. Убедитесь, что установлена среда .NET 4.5 Framework (или более поздней версии), так как она необходима для соединителя сертификатов NDES. .NET 4.5 Framework автоматически входит в состав Windows Server 2012 R2 и более новых версий.
    2. Запустите установщик (NDESConnectorSetup.exe) и примите расположение по умолчанию. Соединитель устанавливается в папке `\Program Files\Microsoft Intune\NDESConnectorUI`. В параметрах установщика выберите **Распределение PFX**. Продолжите процедуру и завершите установку.
    3. По умолчанию служба соединителя выполняется под учетной записью локальной системы. Если прокси-серверу требуется доступ к Интернету, убедитесь, что учетная запись локальной службы может получить доступ к параметрам прокси-сервера на сервере.

5. Microsoft Intune Certificate Connector открывает вкладку **Регистрация**. Чтобы включить подключение к Intune, щелкните **Войти** и укажите данные учетной записи с глобальными административными разрешениями.
6. На вкладке **Дополнительно** рекомендуем установить флажок **Использовать учетную запись SYSTEM этого компьютера (по умолчанию)** .
7. **Применить** > **Закрыть**.
8. Вернитесь на портал Intune (**Intune** > **Конфигурация устройства** > **Соединители сертификатов**). Через несколько секунд появится зеленый флажок, и **Состояние подключения** сменится на **Активно**. Сервер соединителя теперь может взаимодействовать с Intune.
9. Если в сетевой среде есть веб-прокси, то, чтобы обеспечить работу соединителя, может потребоваться произвести дополнительную настройку. Дополнительные сведения см. в статье [Работа с имеющимися локальными прокси-серверами](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-configure-connectors-with-proxy-servers) в документации Azure Active Directory.

> [!NOTE]  
> Microsoft Intune Certificate Connector поддерживает TLS 1.2. Если TLS 1.2 установлен на сервере, на котором размещен соединитель, соединитель использует TLS 1.2. В противном случае используется протокол TLS 1.1. Сейчас TLS 1.1 используется для проверки подлинности между устройствами и сервером.

## <a name="create-a-trusted-certificate-profile"></a>Создание профиля доверенного сертификата

1. На [портале Azure](https://portal.azure.com) выберите **Intune** > **Конфигурация устройства** > **Профили** > **Создать профиль**.
    ![Перейдите к Intune и создайте профиль для доверенного сертификата](media/certificates-pfx-configure/certificates-pfx-configure-profile-new.png)

2. Укажите следующие свойства.

    - **Имя** для профиля.
    - При необходимости задайте описание.
    - **Платформа**, на которой нужно развернуть профиль.
    - Задайте **доверенный сертификат** в качестве **типа профиля**.

3. Перейдите к **параметрам** и укажите CER-файл ранее экспортированного сертификата корневого ЦС.

   > [!NOTE]
   > В зависимости от платформы, выбранной на **шаге 2**, вы можете (или не можете) выбрать **конечное хранилище** для сертификата.

   ![Создайте профиль и отправьте доверенный сертификат](media/certificates-pfx-configure/certificates-pfx-configure-profile-fill.png) 

4. Выберите **ОК** > **Создать**, чтобы сохранить профиль.
5. Чтобы назначить новый профиль для одного или нескольких устройств, см. статью [Назначение профилей устройств Microsoft Intune](device-profile-assign.md).

## <a name="create-a-pkcs-certificate-profile"></a>Создание профиля сертификата PKCS

1. На [портале Azure](https://portal.azure.com) выберите **Intune** > **Конфигурация устройства** > **Профили** > **Создать профиль**.
2. Укажите следующие свойства.

    - **Имя** для профиля.
    - При необходимости задайте описание.
    - **Платформа**, на которой нужно развернуть профиль.
    - Задайте **сертификат PKCS** в качестве **типа профиля**.

3. Откройте **Параметры** и укажите следующие свойства:

    - **Renewal threshold (%)** (Порог обновления (%)). Рекомендуется: 20 %.
    - **Срок действия сертификата**. Если вы не изменяли шаблон сертификата, для этого параметра следует задать один год.
    - **Поставщик хранилища ключей (KSP)** . Для Windows выберите место для хранения ключей на устройстве.
    - **Центр сертификации**. Отображает внутреннее полное доменное имя (FQDN) ЦС предприятия.
    - **Имя центра сертификации**. Отображает имя ЦС предприятия, например "Contoso Certification Authority".
    - **Имя шаблона сертификата**. Имя шаблона, созданного ранее. Помните, что **имя шаблона** по умолчанию совпадает с **отображаемым именем шаблона** *без пробелов*.
    - **Формат имени субъекта**. Задайте для этого параметра значение **Обычное имя** (если не требуется иное).
    - **Альтернативное имя субъекта**. Задайте для этого параметра значение **Имя участника-пользователя** (если не требуется иное).

4. Выберите **ОК** > **Создать**, чтобы сохранить профиль.
5. Чтобы назначить новый профиль для одного или нескольких устройств, см. статью [Назначение профилей устройств Microsoft Intune](device-profile-assign.md).

   > [!NOTE]
   > На устройствах с профилем Android для бизнеса сертификаты, установленные с использованием профиля сертификатов PKCS, не отображаются. Чтобы подтвердить успешность развертывания сертификатов, проверьте состояние профиля в консоли Intune.

## <a name="whats-new-for-connectors"></a>Новые возможности для соединителей
Периодически выпускаются обновления для обоих соединителей сертификатов. При обновлении соединителя вы можете ознакомиться с изменениями здесь. 

*Соединитель сертификатов PFX для Microsoft Intune* [поддерживает автоматические обновления](#requirements), тогда как *соединитель сертификатов Intune* обновляется вручную.

### <a name="may-17-2019"></a>17 мая 2019 г.  
- **Соединитель сертификатов PFX для Microsoft Intune — версия 6.1905.0.404**  
  Изменения в этом выпуске:  
  - Исправлена проблема, при которой существующие PFX-сертификаты продолжали обрабатываться повторно, из-за чего соединитель прекращал обработку новых запросов. 

### <a name="may-6-2019"></a>6 мая 2019 г.  
- **Соединитель сертификатов PFX для Microsoft Intune — версия 6.1905.0.402**  
  Изменения в этом выпуске:  
  - Интервал опроса для соединителя уменьшается с 5 минут до 30 секунд.
 
### <a name="april-2-2019"></a>2 апреля 2019 г.  
- **Соединитель сертификатов Intune — версия 6.1904.1.0**  
  Изменения в этом выпуске:  
  - Устранена проблема, при которой соединитель не может зарегистрироваться в Intune после входа в соединитель с учетной записью глобального администратора.  
  - Включает в себя исправления надежности отзыва сертификатов.  
  - Включает в себя исправления производительности, чтобы увеличить скорость обработки запросов на сертификат PKCS.  

- **Соединитель сертификатов PFX для Microsoft Intune — версия 6.1904.0.401**
  > [!NOTE]  
  > Автоматическое обновление для данной версии соединителя PFX недоступно до 11 апреля 2019 г.  

  Изменения в этом выпуске:  
  - Устранена проблема, при которой соединитель не может зарегистрироваться в Intune после входа в соединитель с учетной записью глобального администратора.  


## <a name="next-steps"></a>Дальнейшие шаги

Профиль создан, но он пока ничего не делает. Далее [назначьте профиль](device-profile-assign.md) и [отслеживайте его состояние](device-profile-monitor.md).

[Используйте SCEP для сертификатов](certificates-scep-configure.md) или [выдайте сертификаты PKCS из веб-службы диспетчера PKI Symantec](certificates-symantec-configure.md).

