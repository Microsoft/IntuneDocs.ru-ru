---
title: "Настройка инфраструктуры сертификатов Microsoft Intune для PKCS"
titlesuffix: Azure portal
description: "Узнайте, как настроить инфраструктуру, а затем создать и назначить сертификаты PKCS в Intune.\""
keywords: 
author: lleonard-msft
ms.author: alleonar
manager: angrobe
ms.date: 06/03/2017
ms.topic: article
ms.prod: 
ms.service: microsoft-intune
ms.technology: 
ms.assetid: e189ebd1-6ca1-4365-9d5d-fab313b7e979
ms.reviewer: vinaybha
ms.suite: ems
ms.custom: intune-azure
ms.openlocfilehash: 1dff7d3e00b26b4f186beb71bacf13738ac857a3
ms.sourcegitcommit: e10dfc9c123401fabaaf5b487d459826c1510eae
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/09/2017
---
# <a name="configure-and-manage-pkcs-certificates-with-intune"></a>Настройка инфраструктуры сертификатов Microsoft Intune для PKCS
[!INCLUDE[azure_portal](./includes/azure_portal.md)]

В этой статье объясняется, как настроить инфраструктуру, а затем создать и назначить профили сертификатов PKCS в Intune.

Для аутентификации на основе сертификатов в организации требуется центр сертификации предприятия.

Для использования профилей сертификатов PKCS, помимо центра сертификации предприятия, требуются следующие компоненты:

-   Компьютер, который может взаимодействовать с центром сертификации, или сам компьютер центра сертификации.

-  Соединитель Intune Certificate Connector, работающий на компьютере, который может взаимодействовать с центром сертификации.

## <a name="important-terms"></a>Важные термины


-    **Домен Active Directory**: все серверы, указанные в этом разделе (за исключением сервера прокси-службы веб-приложения), должны быть присоединены к домену Active Directory.

-  **Центр сертификации**: вам требуется центр сертификации предприятия под управлением выпуска Enterprise Windows Server 2008 R2 или более поздней версии. Автономный ЦС не поддерживается. Инструкции по настройке центра сертификации см. в разделе [Установка центра сертификации](http://technet.microsoft.com/library/jj125375.aspx).
    Если ЦС выполняется под управлением Windows Server 2008 R2, необходимо [установить исправление из KB2483564](http://support.microsoft.com/kb/2483564/).

-  **Компьютер, который может взаимодействовать с центром сертификации**: также можно использовать сам компьютер центра сертификации.
-  **Соединитель Microsoft Intune Certificate Connector**: скачайте установщик **соединителя сертификатов** (**ndesconnectorssetup.exe**) с портала Azure. Затем вы можете запустить **ndesconnectorssetup.exe** на компьютере, где требуется установить соединитель сертификатов. В случае с профилями сертификатов PKCS установите соединитель сертификатов на компьютере, который взаимодействует с центром сертификации.
-  **Сервер прокси-службы веб-приложения** (необязательно): вы можете использовать сервер под управлением Windows Server 2012 R2 или более поздней версии в качестве сервера прокси-службы веб-приложения (WAP). Эта конфигурация:
    -  позволяет устройствам получать сертификаты, используя подключение к Интернету;
    -  является рекомендацией по безопасности, если устройства подключаются к Интернету для получения или возобновления действия сертификатов.

 > [!NOTE]           
> -    На сервере, где размещается WAP, [необходимо установить обновление](http://blogs.technet.com/b/ems/archive/2014/12/11/hotfix-large-uri-request-in-web-application-proxy-on-windows-server-2012-r2.aspx), обеспечивающее поддержку длинных URL-адресов, которые используются службой регистрации сертификатов для сетевых устройств (NDES). Это обновление включено в [накопительный пакет обновления за декабрь 2014 г.](http://support.microsoft.com/kb/3013769), или его можно получить отдельно из [KB3011135](http://support.microsoft.com/kb/3011135).
>-  Сервер, на котором размещается WAP, также должен иметь SSL-сертификат, совпадающий с именем, опубликованным для внешних клиентов, и доверять SSL-сертификату, который используется на сервере NDES. Эти сертификаты позволяют WAP-серверу разорвать SSL-соединение клиентов и создать новое SSL-соединение с сервером NDES.
    Сведения о сертификатах для WAP см. в подразделе **Планирование сертификатов** раздела [Планирование публикации приложений с помощью прокси-службы веб-приложения](https://technet.microsoft.com/library/dn383650.aspx). Общие сведения о WAP-серверах см. в разделе [Работа с прокси-службой веб-приложения](http://technet.microsoft.com/library/dn584113.aspx).|


## <a name="certificates-and-templates"></a>Сертификаты и шаблоны

|Объект|Подробные сведения|
|----------|-----------|
|**Шаблон сертификата**|Настройте этот шаблон в выдающем ЦС.|
|**Доверенный корневой сертификат ЦС**|Вы экспортируете его в виде **CER**-файла из выдающего ЦС или с любого устройства, доверяющего выдающему ЦС, и назначаете его устройству, используя профиль сертификата доверенного ЦС.<br /><br />Для каждой платформы операционной системы используется один доверенный корневой сертификат ЦС, который связывается с каждым созданным профилем доверенного корневого сертификата.<br /><br />При необходимости можно использовать дополнительные доверенные корневые сертификаты ЦС. Например, это можно сделать, чтобы предоставить доверие ЦС, подписывающему сертификаты проверки подлинности сервера для точек доступа Wi-Fi.|


## <a name="configure-your-infrastructure"></a>Настройка инфраструктуры
Перед настройкой профилей сертификатов необходимо выполнить описанные ниже инструкции. Эти инструкции предполагают, что вы знакомы с Windows Server 2012 R2 и службами сертификатов Active Directory (ADCS):

- **Шаг 1**. Настройка шаблонов сертификатов в центре сертификации.
- **Шаг 2**. Включение, установка и настройка соединителя сертификатов Intune.

## <a name="step-1---configure-certificate-templates-on-the-certification-authority"></a>Шаг 1. Настройка шаблонов сертификатов в центре сертификации

### <a name="to-configure-the-certification-authority"></a>Настройка центра сертификации

1.  В выдающем центре сертификации с помощью оснастки "Шаблоны сертификатов" создайте новый пользовательский шаблон либо скопируйте и измените существующий (например, шаблон пользователя) для использования с PKCS.

    Шаблон должен включать в себя следующее:

    -   Укажите понятное **Отображаемое имя шаблона** .

    -   На вкладке **Имя субъекта** выберите **Отправить в запросе**. (Безопасность обеспечивается модулем политики Intune для NDES.)

    -   На вкладке **Расширения** включите в раздел **Описание политик приложений** пункт **Проверка подлинности клиента**.

        > [!IMPORTANT]
        > Для шаблонов сертификатов iOS и macOS измените на вкладке **Расширения** параметр **Использование ключей** и снимите флажок **Подпись подтверждает подлинность**.

2.  Просмотрите **Период действия** на вкладке **Общие** шаблона. По умолчанию в Intune используется значение, настроенное в шаблоне. Однако в настройках ЦС вы можете разрешить инициатору запроса указывать другое значение, которое можно затем задать в консоли администрирования Intune. Если вы хотите всегда использовать значение в шаблоне, пропустите остальные действия этого шага.

    > [!IMPORTANT]
    > Системы iOS и macOS всегда используют значение, заданное в шаблоне, невзирая на другие настройки.

    Чтобы настройки ЦС позволяли инициатору запроса указывать срок действия, выполните в ЦС следующие команды:

    а.  **certutil -setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE**

    b.  **net stop certsvc**

    в.  **net start certsvc**

3.  В выдающем ЦС используйте оснастку центра сертификации, чтобы опубликовать шаблон сертификата.

    а.  Выберите узел **Шаблоны сертификата**, щелкните **Действие**- &gt; **Создать ** &gt; **Выдаваемый шаблон сертификата**, а затем укажите шаблон, созданный в шаге 2.

    b.  Убедитесь, что шаблон опубликован, просмотрев его в папке **Шаблоны сертификата** .

4.  На компьютере центра сертификации убедитесь, что компьютер, на котором размещен соединитель Intune Certificate Connector, имеет разрешение на регистрацию и может получить доступ к шаблону, используемому при создании профиля сертификатов PKCS. Задайте это разрешение на вкладке **Безопасность** свойств компьютера ЦС.

## <a name="step-2---enable-install-and-configure-the-intune-certificate-connector"></a>Шаг 2. Включение, установка и настройка соединителя сертификатов Intune
В этом шаге вы сделаете следующее:

- Включение поддержки для соединителя сертификатов
- скачаете, установите и настроите соединитель сертификатов.

### <a name="to-enable-support-for-the-certificate-connector"></a>Включение поддержки для соединителя сертификатов

1.  Зарегистрируйтесь на портале Azure.
2.  Выберите **Больше служб** > **Мониторинг и управление** > **Intune**.
3.  В колонке **Intune** выберите **Настройка устройств**.
2.  В колонке **Конфигурация устройства** выберите **Настройка** > **Центр сертификации**.
2.  В разделе **Шаг 1** выберите **Включить**.

### <a name="to-download-install-and-configure-the-certificate-connector"></a>Скачивание, установка и настройка соединителя сертификатов

1.  В колонке **Конфигурация устройства** выберите **Настройка** > **Центр сертификации**.
2.  Выберите **Скачать соединитель сертификатов**.
2.  После скачивания запустите установщик (**ndesconnectorssetup.exe**).
  Запустите установщик на компьютере, который может подключиться к центру сертификации. Выберите параметр распределения PKCS (PFX) и нажмите кнопку **Установить**. По завершении установки создайте профиль сертификата, как описано в статье о [настройке профилей сертификатов](certificates-configure.md).

3.  При запросе сертификата клиента для соединителя сертификатов щелкните **Выбрать** и укажите установленный сертификат, который будет использоваться для **аутентификации клиента**.

    После выбора сертификата проверки подлинности клиента вы вернетесь на поверхность **Сертификата клиента для соединителя сертификатов Microsoft Intune** . Хотя выбранный сертификат не отображается, нажмите кнопку **Далее**, чтобы просмотреть свойства этого сертификата. После этого выберите **Далее** и **Установить**.

4.  После завершения работы мастера, но перед тем, как закрыть его, щелкните **Запустить пользовательский интерфейс соединителя сертификатов**.

    > [!TIP]
    > Если вы закроете мастер перед запуском пользовательского интерфейса соединителя сертификатов, вы можете повторно открыть его, выполнив следующую команду:
    >
    > **&lt;путь_установки&gt;\NDESConnectorUI\NDESConnectorUI.exe**

5.  В пользовательском интерфейсе **соединителя сертификатов** :

    а. Выберите **Войти** и введите учетные данные администратора службы Intune или учетные данные администратора клиента с разрешениями глобального администратора.

  <!--  If your organization uses a proxy server and the proxy is needed for the NDES server to access the Internet, click **Use proxy server** and then provide the proxy server name, port, and account credentials to connect.-->

    b. Откройте вкладку **Дополнительно**, а затем укажите учетные данные учетной записи с разрешением **Выдача сертификатов и управление ими** в выдающем центре сертификации.

    в. Нажмите кнопку **Применить**.

    Теперь можно закрыть пользовательский интерфейс соединителя сертификатов.

6.  Откройте командную строку и введите **services.msc**. Затем нажмите клавишу **ВВОД**, щелкните правой кнопкой мыши элемент **Служба соединителя Intune** и выберите пункт **Перезапустить**.

Чтобы убедиться, что служба работает, откройте браузер и введите следующий URL-адрес (он должен вернуть ошибку **403** ):

**http:// &lt;полное_доменное_имя_сервера_NDES&gt;/certsrv/mscep/mscep.dll**


### <a name="how-to-create-a-pkcs-certificate-profile"></a>Как создать профиль сертификатов PKCS

На портале Azure выберите рабочую нагрузку **Настройка устройств**.
2. В колонке **Конфигурация устройства** выберите **Управление** > **Профили**.
3. В колонке профилей выберите **Создать профиль**.
4. В колонке **Создать профиль** в соответствующих полях введите **Имя** и **Описание** для профиля сертификата PKCS.
5. Из раскрывающегося списка **Платформа** выберите платформу устройств для этого сертификата PKCS:
    - **Android**
    - **Android for Work**
    - **iOS**
    - **Windows 10 и более поздние версии**.
6. Из раскрывающегося списка **Профиль** выберите **Сертификат PKCS**.
7. В колонке **Сертификат PKCS** настройте следующие параметры:
    - **Renewal threshold (%)** (Порог обновления (%)). Укажите процент времени существования сертификата, который остается, прежде чем устройство запросит его возобновление.
    - **Срок действия сертификата.** Запустив на выдающем ЦС команду **certutil - setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE**, которая позволяет использовать настраиваемый срок действия, вы можете указать оставшееся время до истечения срока действия сертификата.<br>Можно указать значение, ниже, но не выше периода действия в указанном шаблоне сертификата. Например, если в шаблоне сертификата указан срок действия сертификата в два года, можно указать значение в один год, но не в пять лет. Кроме того, значение не должно превышать значение оставшегося периода действия сертификата, выдаваемого центром сертификации.
    - **Поставщик хранилища ключей** (Windows 10): укажите, где будет храниться ключ для сертификата. Выберите одно из следующих значений:
        - **Зарегистрировать в KSP доверенного платформенного модуля (TPM) при его наличии, в противном случае зарегистрировать в KSP программного обеспечения**.
        - **Зарегистрировать в KSP доверенного платформенного модуля (TPM), в противном случае создать сбой**.
        - **Зарегистрировать в паспорте, в противном случае создать сбой (Windows 10 и более поздних версий)**.
        - **Зарегистрировать в KSP программного обеспечения**.
    - **Центр сертификации**: вам требуется центр сертификации предприятия под управлением выпуска Enterprise Windows Server 2008 R2 или более поздней версии. Автономный ЦС не поддерживается. Инструкции по настройке центра сертификации см. в разделе [Установка центра сертификации](http://technet.microsoft.com/library/jj125375.aspx). Если ЦС выполняется под управлением Windows Server 2008 R2, необходимо [установить исправление из KB2483564](http://support.microsoft.com/kb/2483564/).
    - **Имя центра сертификации**. Введите имя центра сертификации.
    - **Имя шаблона сертификата.** Введите имя шаблона сертификата, для использования которого настроена служба регистрации сертификатов для сетевых устройств и который добавлен в выдающий ЦС.
    Убедитесь, что оно в точности совпадает с именем одного из шаблонов сертификатов, перечисленных в реестре сервера, на котором запущена служба регистрации сертификатов для сетевых устройств. Убедитесь, что вы ввели имя шаблона сертификата, а не отображаемое имя шаблона сертификата. 
    Чтобы найти имена шаблонов сертификатов, перейдите к следующему разделу реестра: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MSCEP. Вы увидите шаблоны сертификатов, перечисленные в виде значений для параметров **EncryptionTemplate**, **GeneralPurposeTemplate**и **SignatureTemplate**. По умолчанию для всех трех шаблонов сертификатов используется значение IPSECIntermediateOffline, которое соответствует отображаемому имени шаблона **IPSec (автономный запрос)**. 
    - **Формат имени субъекта.** Выберите в списке способ, с помощью которого Intune автоматически создает имя субъекта в запросе на сертификат. Если сертификат предназначен для пользователя, в имя субъекта можно также включить адрес электронной почты пользователя. Выберите один из следующих типов.
        - **Не настроено**.
        - **Обычное имя**.
        - **Обычное имя с адресом электронной почты**.
        - **Обычное имя как адрес электронной почты**.
    - **Альтернативное имя субъекта.** Укажите способ, с помощью которого Intune автоматически создает значения для альтернативного имени субъекта в запросе на сертификат. Например, если вы выбрали тип сертификата пользователя, в альтернативное имя субъекта можно включить имя участника-пользователя. Если сертификат клиента будет использоваться для проверки подлинности сервера политики сети, в качестве альтернативного имени субъекта необходимо задать имя участника-пользователя. 
    Кроме того, можно выбрать **настраиваемый атрибут Azure AD**. При выборе этого параметра появляется дополнительное поле с раскрывающимся списком. В поле с раскрывающимся списком **Настраиваемый атрибут Azure AD** представлен параметр **Отдел**. Если выбран этот параметр, но в Azure AD не определен отдел, сертификат выдаваться не будет. Чтобы устранить эту проблему, определите отдел и сохраните изменения. При следующем возврате устройства проблема устраняется, после чего выдается сертификат. В этом поле используется нотация ASN.1. 
    - **Расширенное использование ключа** (Android). Выберите **Добавить**, чтобы добавить значения для назначения сертификата. В большинстве случаев для сертификата потребуется **Проверка подлинности клиента** , чтобы пользователь или устройство могли выполнить проверку подлинности на сервере. Однако при необходимости можно добавить любые другие варианты использования ключа. 
    - **Корневой сертификат** (Android). Выберите профиль корневого сертификата ЦС, настроенный ранее и назначенный пользователю или устройству. Этот сертификат ЦС должен быть корневым сертификатом ЦС, который выдаст сертификат, настраиваемый в данном профиле сертификата. Это доверенный профиль сертификатов, который вы создали ранее.
8. По завершении вернитесь в колонку **Создание профиля** и щелкните **Создать**.

Созданный профиль отобразится в колонке со списком профилей.

## <a name="how-to-assign-the-certificate-profile"></a>Как назначить профиль сертификата

Прежде чем назначать группам профили сертификатов, необходимо учесть следующее:

- При назначении профилей сертификатов группам на устройстве устанавливается файл сертификата из профиля сертификата доверенного ЦС. Устройство использует профиль сертификатов PKCS, чтобы создать запрос на сертификат.
- Профили сертификата устанавливаются на устройствах только той платформы, которую вы использовали при создании профиля.
- Можно назначать профили сертификатов и для коллекции пользователей, и для устройств.
- Чтобы опубликовать сертификат на устройстве сразу после регистрации, назначьте профиль сертификата в группе пользователей, а не в группе устройств. Если вы назначаете профиль группе устройств, требуется полная регистрация устройства для получения политик.
- Хотя каждый профиль назначается отдельно, вам потребуется доверенный корневой ЦС, а также профиль PKCS. Иначе произойдет сбой политики сертификата PKCS.

Дополнительные сведения см. в статье о [назначении профилей устройств](device-profile-assign.md).
